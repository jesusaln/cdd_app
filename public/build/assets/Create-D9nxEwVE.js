import{r as i,c as U,T as ue,p as ce,O as pe,i as ve,o as fe,g as f,f as t,u as p,Z as me,q as ge,l as m,v as A,z as B,F as be}from"./vendor-d19pJyVS.js";import{N as he}from"./app-BcT2PLJy.js";import{A as xe}from"./AppLayout-CcnrZQKI.js";import{_ as ye,a as we,b as ke}from"./BotonesAccion-DYwTTkJE.js";import{_ as _e}from"./BuscarCliente-t4xPlwkv.js";import{_ as Pe}from"./BuscarProducto-B_taEjGP.js";import{P as je}from"./PySSeleccionados-5J0ZMOZn.js";import{_ as Ce}from"./VistaPreviaModal-CAwANwka.js";import{_ as Fe}from"./MarginAlertModal-CSRzALEf.js";import{_ as Se}from"./CrearClienteModal-B7UwTQZh.js";import"./utils-Dq7h7Pqt.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Modal-DXOFbFUN.js";import"./PrimaryButton-D_2lIeSZ.js";import"./SecondaryButton-BHgzZ2Qe.js";const $e={class:"pedidos-create min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6"},Ne={class:"max-w-6xl mx-auto"},Me={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ee={class:"p-6 grid grid-cols-1 md:grid-cols-2 gap-6"},Ae={class:"relative"},Be={class:"relative"},Ve={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ie={class:"p-6"},qe={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Le={class:"p-6"},De={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},ze={class:"p-6"},w="P0001",to=Object.assign({layout:xe},{__name:"Create",props:{clientes:Array,productos:{type:Array,default:()=>[]},servicios:{type:Array,default:()=>[]},catalogs:{type:Object,default:()=>({})}},setup(y){const V=new he({duration:5e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10B981",icon:{className:"notyf__icon--success",tagName:"i",text:"✓"}},{type:"error",background:"#EF4444",icon:{className:"notyf__icon--error",tagName:"i",text:"✗"}},{type:"info",background:"#3B82F6",icon:{className:"notyf__icon--info",tagName:"i",text:"ℹ"}}]}),n=(e,o="success")=>{V.open({type:o,message:e})},C=y,F=i([...C.clientes]),O=U(()=>C.catalogs),k=()=>{const e=new Date,o=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${o}-${r}-${l}`},a=ue({numero_pedido:w,fecha_pedido:k(),cliente_id:"",subtotal:0,descuento_items:0,iva:0,total:0,productos:[],notas:"",estado:"borrador"}),R=i(null),G=i(null),s=i([]),d=i({}),v=i({}),u=i({}),c=i(null),S=i(!1),_=i(!0),P=i(!1),j=i([]),$=i(!1),N=i(!1),I=i(""),Q=(e,o)=>{try{localStorage.setItem(e,JSON.stringify(o))}catch(r){console.warn("No se pudo guardar en localStorage:",r)}},J=e=>{try{const o=localStorage.getItem(e);return o?JSON.parse(o):null}catch(o){return console.warn("No se pudo cargar desde localStorage:",o),null}},M=e=>{try{localStorage.removeItem(e)}catch(o){console.warn("No se pudo eliminar de localStorage:",o)}},Y=()=>{c.value&&s.value.length>0?S.value=!0:n("Selecciona un cliente y al menos un producto","error")},Z=()=>{_.value=!1},q=e=>{var o;if(!e){c.value=null,a.cliente_id="",x(),n("Selección de cliente limpiada","info");return}((o=c.value)==null?void 0:o.id)!==e.id&&(c.value=e,a.cliente_id=e.id,x(),n(`Cliente seleccionado: ${e.nombre_razon_social}`))},K=e=>{I.value=e,N.value=!0},W=e=>{F.value.some(o=>o.id===e.id)||F.value.push(e),q(e)},X=e=>{if(!e||typeof e.id>"u"||!e.tipo){n("Producto inválido","error");return}const o={id:e.id,tipo:e.tipo};if(!s.value.some(l=>l.id===e.id&&l.tipo===e.tipo)){s.value.push(o);const l=`${e.tipo}-${e.id}`;d.value[l]=1;let g=0;e.tipo==="producto"?g=typeof e.precio_venta=="number"?e.precio_venta:0:g=typeof e.precio=="number"?e.precio:0,v.value[l]=g,u.value[l]=0,h(),x(),n(`Producto añadido: ${e.nombre||e.descripcion||"Item"}`)}},ee=e=>{if(!e||typeof e.id>"u"||!e.tipo)return;const o=`${e.tipo}-${e.id}`;s.value=s.value.filter(r=>!(r.id===e.id&&r.tipo===r.tipo)),delete d.value[o],delete v.value[o],delete u.value[o],h(),x(),n(`Producto eliminado: ${e.nombre||e.descripcion||"Item"}`,"info")},oe=(e,o)=>{const r=parseFloat(o);isNaN(r)||r<0||(d.value[e]=r,h(),x())},te=(e,o)=>{const r=parseFloat(o);isNaN(r)||r<0||r>100||(u.value[e]=r,h(),x())},b=U(()=>{let e=0,o=0;s.value.forEach(D=>{const E=`${D.tipo}-${D.id}`,z=parseFloat(d.value[E])||0,H=parseFloat(v.value[E])||0,de=parseFloat(u.value[E])||0;if(z>0&&H>=0){const T=z*H;o+=T*(de/100),e+=T}});const r=Math.max(0,e-o),l=r*.16,g=r+l;return{subtotal:parseFloat(e.toFixed(2)),descuentoItems:parseFloat(o.toFixed(2)),subtotalConDescuentos:parseFloat(r.toFixed(2)),iva:parseFloat(l.toFixed(2)),total:parseFloat(g.toFixed(2))}}),h=()=>{a.subtotal=b.value.subtotal,a.descuento_items=b.value.descuentoItems,a.iva=b.value.iva,a.total=b.value.total},re=()=>{if(!a.cliente_id)return!1;if(s.value.length===0)return n("Agrega al menos un producto o servicio","error"),!1;for(const e of s.value){const o=`${e.tipo}-${e.id}`,r=parseFloat(u.value[o])||0,l=parseFloat(d.value[o])||0,g=parseFloat(v.value[o])||0;if(r<0||r>100)return n("Los descuentos deben estar entre 0% y 100%.","error"),!1;if(l<=0)return n("Las cantidades deben ser mayores a 0","error"),!1;if(g<0)return n("Los precios no pueden ser negativos","error"),!1}return!0},ae=()=>{var e;c.value=null,a.cliente_id="",s.value=[],d.value={},v.value={},u.value={},a.notas="",a.numero_pedido=w,a.fecha_pedido=k(),localStorage.removeItem(`pedido_edit_${(e=C.pedido)==null?void 0:e.id}`),V.success("Formulario limpiado correctamente")},se=()=>{re()&&(a.productos=s.value.map(e=>{const o=`${e.tipo}-${e.id}`;return{id:e.id,tipo:e.tipo,cantidad:parseFloat(d.value[o])||1,precio:parseFloat(v.value[o])||0,descuento:parseFloat(u.value[o])||0}}),h(),a.post(route("pedidos.store"),{onSuccess:e=>{var o,r;if((o=e.props.flash)!=null&&o.warning&&((r=e.props.flash)!=null&&r.requiere_confirmacion_margen)){j.value=e.props.flash.productos_bajo_margen||[],P.value=!0;return}M("pedidoEnProgreso"),s.value=[],d.value={},v.value={},u.value={},c.value=null,a.reset(),n("Pedido creado con éxito")},onError:e=>{console.error("Errores de validación:",e);const o=Object.values(e)[0];Array.isArray(o)?n(o[0],"error"):n("Hubo errores de validación","error")}}))},L=e=>{(a.cliente_id||s.value.length>0)&&(e.preventDefault(),e.returnValue="Tienes cambios sin guardar. ¿Estás seguro de que quieres salir?")},x=()=>{const e={numero_pedido:w,fecha_pedido:a.fecha_pedido,cliente_id:a.cliente_id,cliente:c.value,selectedProducts:s.value,quantities:d.value,prices:v.value,discounts:u.value};Q("pedidoEnProgreso",e)},ne=()=>{const e=k();a.fecha_pedido!==e&&(a.fecha_pedido=e)};ce(()=>{n(`Número de pedido fijo: ${w}`,"info");const e=J("pedidoEnProgreso");if(e&&typeof e=="object")try{a.numero_pedido=w,a.fecha_pedido=k(),a.cliente_id=e.cliente_id||"",c.value=e.cliente||null,s.value=Array.isArray(e.selectedProducts)?e.selectedProducts:[],d.value=e.quantities||{},v.value=e.prices||{},u.value=e.discounts||{},h()}catch(o){console.warn("Error al cargar datos guardados:",o),M("pedidoEnProgreso")}setInterval(()=>{ne()},5*60*1e3),window.addEventListener("beforeunload",L)}),pe(()=>{window.removeEventListener("beforeunload",L),typeof fechaInterval<"u"&&clearInterval(fechaInterval)});const le=()=>{P.value=!1,j.value=[]},ie=async()=>{$.value=!0;try{a.ajustar_margen=!0,a.post(route("pedidos.store"),{onSuccess:()=>{P.value=!1,j.value=[],M("pedidoEnProgreso"),s.value=[],d.value={},v.value={},u.value={},c.value=null,a.reset(),n("Pedido creado con precios ajustados automáticamente")},onError:e=>{console.error("Errores al ajustar precios:",e),n("Error al ajustar precios automáticamente","error")}})}catch(e){console.error("Error al ajustar precios:",e),n("Error al procesar el ajuste automático","error")}finally{$.value=!1}};return(e,o)=>(fe(),ve(be,null,[f(p(me),{title:"Crear Pedido"}),t("div",$e,[t("div",Ne,[f(ye,{title:"Nuevo Pedido",description:"Crea un nuevo pedido para tus clientes","can-preview":c.value&&s.value.length>0,"back-url":e.route("pedidos.index"),"show-shortcuts":_.value,onPreview:Y,onCloseShortcuts:Z},null,8,["can-preview","back-url","show-shortcuts"]),t("form",{onSubmit:ge(se,["prevent"]),class:"space-y-8"},[t("div",Me,[o[14]||(o[14]=t("div",{class:"bg-gradient-to-r from-indigo-500 to-indigo-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})]),m(" Información General ")])],-1)),t("div",Ee,[t("div",null,[o[9]||(o[9]=t("label",{for:"numero_pedido",class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},[m(" Número de Pedido * "),t("span",{class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"},[t("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),m(" Número fijo ")])],-1)),t("div",Ae,[A(t("input",{id:"numero_pedido","onUpdate:modelValue":o[0]||(o[0]=r=>p(a).numero_pedido=r),type:"text",class:"w-full bg-gray-50 text-gray-500 cursor-not-allowed border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent",placeholder:"P0001",readonly:"",required:""},null,512),[[B,p(a).numero_pedido]]),o[8]||(o[8]=t("div",{class:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"},[t("svg",{class:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})])],-1))]),o[10]||(o[10]=t("p",{class:"mt-1 text-xs text-gray-500"}," Este número es fijo para todos los pedidos ",-1))]),t("div",null,[o[12]||(o[12]=t("label",{for:"fecha_pedido",class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},[m(" Fecha de Pedido * "),t("span",{class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"},[t("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})]),m(" Automática ")])],-1)),t("div",Be,[A(t("input",{id:"fecha_pedido","onUpdate:modelValue":o[1]||(o[1]=r=>p(a).fecha_pedido=r),type:"date",class:"w-full bg-gray-50 text-gray-500 cursor-not-allowed border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent",readonly:"",required:""},null,512),[[B,p(a).fecha_pedido]]),o[11]||(o[11]=t("div",{class:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"},[t("svg",{class:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1))]),o[13]||(o[13]=t("p",{class:"mt-1 text-xs text-gray-500"}," Esta fecha se establece automáticamente con la fecha de creación ",-1))])])]),t("div",Ve,[o[15]||(o[15]=t("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})]),m(" Información del Cliente ")])],-1)),t("div",Ie,[f(_e,{ref_key:"buscarClienteRef",ref:R,clientes:F.value,"cliente-seleccionado":c.value,onClienteSeleccionado:q,onCrearNuevoCliente:K},null,8,["clientes","cliente-seleccionado"])])]),t("div",qe,[o[16]||(o[16]=t("div",{class:"bg-gradient-to-r from-green-500 to-green-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})]),m(" Productos y Servicios ")])],-1)),t("div",Le,[f(Pe,{ref_key:"buscarProductoRef",ref:G,productos:y.productos,servicios:y.servicios,onAgregarProducto:X},null,8,["productos","servicios"]),f(je,{selectedProducts:s.value,productos:y.productos,servicios:y.servicios,quantities:d.value,prices:v.value,discounts:u.value,onEliminarProducto:ee,onUpdateQuantity:oe,onUpdateDiscount:te},null,8,["selectedProducts","productos","servicios","quantities","prices","discounts"])])]),t("div",De,[o[17]||(o[17]=t("div",{class:"bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})]),m(" Notas Adicionales ")])],-1)),t("div",ze,[A(t("textarea",{"onUpdate:modelValue":o[2]||(o[2]=r=>p(a).notas=r),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical",rows:"4",placeholder:"Agrega notas adicionales, términos y condiciones, o información relevante para el pedido..."},null,512),[[B,p(a).notas]])])]),f(we,{"show-margin-calculator":!1,"margin-data":{costoTotal:0,precioVenta:0,ganancia:0,margenPorcentaje:0},totals:b.value,"item-count":s.value.length,"total-quantity":Object.values(d.value).reduce((r,l)=>r+(l||0),0),"onUpdate:descuentoGeneral":o[3]||(o[3]=r=>p(a).descuento_general=r)},null,8,["totals","item-count","total-quantity"]),f(ke,{"back-url":e.route("pedidos.index"),"is-processing":p(a).processing,"can-submit":p(a).cliente_id&&s.value.length>0,"button-text":p(a).processing?"Guardando...":"Crear Pedido",onLimpiar:ae},null,8,["back-url","is-processing","can-submit","button-text"])],32),t("button",{onClick:o[4]||(o[4]=r=>_.value=!_.value),class:"fixed bottom-4 left-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200",title:"Mostrar atajos de teclado"},o[18]||(o[18]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)]))])]),f(Ce,{show:S.value,type:"pedido",cliente:c.value,items:s.value,totals:b.value,notas:p(a).notas,onClose:o[5]||(o[5]=r=>S.value=!1),onPrint:o[6]||(o[6]=()=>e.window.print())},null,8,["show","cliente","items","totals","notas"]),f(Fe,{show:P.value,"productos-bajo-margen":j.value,processing:$.value,onClose:le,onAjustarAutomaticamente:ie},null,8,["show","productos-bajo-margen","processing"]),f(Se,{show:N.value,catalogs:O.value,"nombre-inicial":I.value,onClose:o[7]||(o[7]=r=>N.value=!1),onClienteCreado:W},null,8,["show","catalogs","nombre-inicial"])],64))}});export{to as default};
