import{r as i,c as U,T as de,p as ve,O as pe,i as O,o as R,g as m,f as t,u as c,Z as fe,q as me,k as ge,l as f,v as V,z as $,t as be,F as he}from"./vendor-d19pJyVS.js";import{N as xe}from"./app-BcT2PLJy.js";import{A as we}from"./AppLayout-CcnrZQKI.js";import{_ as ye,a as ke,b as Ce}from"./BotonesAccion-DYwTTkJE.js";import{_ as _e}from"./BuscarCliente-t4xPlwkv.js";import{_ as Fe}from"./BuscarProducto-B_taEjGP.js";import{P as Se}from"./PySSeleccionados-5J0ZMOZn.js";import{_ as je}from"./VistaPreviaModal-CAwANwka.js";import{_ as Me}from"./CrearClienteModal-B7UwTQZh.js";import"./utils-Dq7h7Pqt.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ne={class:"ventas-create min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6"},Pe={class:"max-w-6xl mx-auto"},Ve={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},$e={class:"p-6 grid grid-cols-1 md:grid-cols-2 gap-6"},Ae={class:"relative"},Be={class:"relative"},Ee={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Le={class:"p-6"},qe={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ie={class:"p-6"},De={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},ze={class:"p-6"},He={key:0,class:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6"},Te={class:"flex items-start"},Ue={class:"flex-1"},Oe={class:"text-sm text-yellow-700 mb-3 whitespace-pre-line"},C="V0001",to=Object.assign({layout:we},{__name:"Create",props:{clientes:Array,productos:{type:Array,default:()=>[]},servicios:{type:Array,default:()=>[]},catalogs:{type:Object,default:()=>({})}},setup(k){const A=new xe({duration:5e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10B981",icon:{className:"notyf__icon--success",tagName:"i",text:"✓"}},{type:"error",background:"#EF4444",icon:{className:"notyf__icon--error",tagName:"i",text:"✗"}},{type:"info",background:"#3B82F6",icon:{className:"notyf__icon--info",tagName:"i",text:"ℹ"}}]}),n=(e,o="success")=>{A.open({type:o,message:e})},S=k,j=i([...S.clientes]),G=U(()=>S.catalogs),_=()=>{const e=new Date,o=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${o}-${a}-${l}`},r=de({numero_venta:C,fecha:_(),cliente_id:"",subtotal:0,descuento_items:0,iva:0,total:0,productos:[],notas:"",estado:"borrador"}),Q=i(null),J=i(null),s=i([]),u=i({}),p=i({}),d=i({}),v=i(null),M=i(!1),F=i(!0),b=i(!1),h=i(""),N=i(!1),B=i(""),Y=(e,o)=>{try{localStorage.setItem(e,JSON.stringify(o))}catch(a){console.warn("No se pudo guardar en localStorage:",a)}},Z=e=>{try{const o=localStorage.getItem(e);return o?JSON.parse(o):null}catch(o){return console.warn("No se pudo cargar desde localStorage:",o),null}},E=e=>{try{localStorage.removeItem(e)}catch(o){console.warn("No se pudo eliminar de localStorage:",o)}},K=()=>{v.value&&s.value.length>0?M.value=!0:n("Selecciona un cliente y al menos un producto","error")},W=()=>{F.value=!1},L=e=>{var o;if(!e){v.value=null,r.cliente_id="",y(),n("Selección de cliente limpiada","info");return}((o=v.value)==null?void 0:o.id)!==e.id&&(v.value=e,r.cliente_id=e.id,y(),n(`Cliente seleccionado: ${e.nombre_razon_social}`))},X=e=>{B.value=e,N.value=!0},ee=e=>{j.value.some(o=>o.id===e.id)||j.value.push(e),L(e)},oe=e=>{if(!e||typeof e.id>"u"||!e.tipo){n("Producto inválido","error");return}const o={id:e.id,tipo:e.tipo};if(!s.value.some(l=>l.id===e.id&&l.tipo===e.tipo)){s.value.push(o);const l=`${e.tipo}-${e.id}`;u.value[l]=1;let g=0;e.tipo==="producto"?g=typeof e.precio_venta=="number"?e.precio_venta:0:g=typeof e.precio=="number"?e.precio:0,p.value[l]=g,d.value[l]=0,w(),y(),n(`Producto añadido: ${e.nombre||e.descripcion||"Item"}`)}},te=e=>{if(!e||typeof e.id>"u"||!e.tipo)return;const o=`${e.tipo}-${e.id}`;s.value=s.value.filter(a=>!(a.id===e.id&&a.tipo===a.tipo)),delete u.value[o],delete p.value[o],delete d.value[o],w(),y(),n(`Producto eliminado: ${e.nombre||e.descripcion||"Item"}`,"info")},ae=()=>{var e;v.value=null,r.cliente_id="",s.value=[],u.value={},p.value={},d.value={},r.notas="",r.numero_venta=C,r.fecha=_(),b.value=!1,h.value="",localStorage.removeItem(`venta_edit_${(e=S.venta)==null?void 0:e.id}`),A.success("Formulario limpiado correctamente")},re=(e,o)=>{const a=parseFloat(o);isNaN(a)||a<0||(u.value[e]=a,w(),y())},se=(e,o)=>{const a=parseFloat(o);isNaN(a)||a<0||a>100||(d.value[e]=a,w(),y())},x=U(()=>{let e=0,o=0;s.value.forEach(D=>{const P=`${D.tipo}-${D.id}`,z=parseFloat(u.value[P])||0,H=parseFloat(p.value[P])||0,ce=parseFloat(d.value[P])||0;if(z>0&&H>=0){const T=z*H;o+=T*(ce/100),e+=T}});const a=Math.max(0,e-o),l=a*.16,g=a+l;return{subtotal:parseFloat(e.toFixed(2)),descuentoItems:parseFloat(o.toFixed(2)),subtotalConDescuentos:parseFloat(a.toFixed(2)),iva:parseFloat(l.toFixed(2)),total:parseFloat(g.toFixed(2))}}),w=()=>{r.subtotal=x.value.subtotal,r.descuento_items=x.value.descuentoItems,r.iva=x.value.iva,r.total=x.value.total},ne=()=>{if(!r.cliente_id)return!1;if(s.value.length===0)return n("Agrega al menos un producto o servicio","error"),!1;for(const e of s.value){const o=`${e.tipo}-${e.id}`,a=parseFloat(d.value[o])||0,l=parseFloat(u.value[o])||0,g=parseFloat(p.value[o])||0;if(a<0||a>100)return n("Los descuentos deben estar entre 0% y 100%.","error"),!1;if(l<=0)return n("Las cantidades deben ser mayores a 0","error"),!1;if(g<0)return n("Los precios no pueden ser negativos","error"),!1}return!0},le=()=>{r.ajustar_margen=!0,b.value=!1,h.value="",q()},ie=()=>{b.value=!1,h.value="",n("Revisa los precios de los productos antes de continuar","info")},q=()=>{ne()&&(r.productos=s.value.map(e=>{const o=`${e.tipo}-${e.id}`;return{id:e.id,tipo:e.tipo,cantidad:parseFloat(u.value[o])||1,precio:parseFloat(p.value[o])||0,descuento:parseFloat(d.value[o])||0}}),w(),r.post(route("ventas.store"),{onSuccess:()=>{E("ventaEnProgreso"),s.value=[],u.value={},p.value={},d.value={},v.value=null,r.reset(),b.value=!1,h.value="",n("Venta creada con éxito")},onError:e=>{if(e.warning&&e.requiere_confirmacion_margen){b.value=!0,h.value=e.warning,n("Se requiere confirmación de márgenes","warning");return}console.error("Errores de validación:",e);const o=Object.values(e)[0];Array.isArray(o)?n(o[0],"error"):n("Hubo errores de validación","error")}}))},I=e=>{(r.cliente_id||s.value.length>0)&&(e.preventDefault(),e.returnValue="Tienes cambios sin guardar. ¿Estás seguro de que quieres salir?")},y=()=>{const e={numero_venta:C,fecha:r.fecha,cliente_id:r.cliente_id,cliente:v.value,selectedProducts:s.value,quantities:u.value,prices:p.value,discounts:d.value};Y("ventaEnProgreso",e)},ue=()=>{const e=_();r.fecha!==e&&(r.fecha=e)};return ve(()=>{n(`Número de venta fijo: ${C}`,"info");const e=Z("ventaEnProgreso");if(e&&typeof e=="object")try{r.numero_venta=C,r.fecha=_(),r.cliente_id=e.cliente_id||"",v.value=e.cliente||null,s.value=Array.isArray(e.selectedProducts)?e.selectedProducts:[],u.value=e.quantities||{},p.value=e.prices||{},d.value=e.discounts||{},w()}catch(o){console.warn("Error al cargar datos guardados:",o),E("ventaEnProgreso")}setInterval(()=>{ue()},5*60*1e3),window.addEventListener("beforeunload",I)}),pe(()=>{window.removeEventListener("beforeunload",I),typeof fechaInterval<"u"&&clearInterval(fechaInterval)}),(e,o)=>(R(),O(he,null,[m(c(fe),{title:"Crear Venta"}),t("div",Ne,[t("div",Pe,[m(ye,{title:"Nueva Venta",description:"Crea una nueva venta para tus clientes","can-preview":v.value&&s.value.length>0,"back-url":e.route("ventas.index"),"show-shortcuts":F.value,onPreview:K,onCloseShortcuts:W},null,8,["can-preview","back-url","show-shortcuts"]),t("form",{onSubmit:me(q,["prevent"]),class:"space-y-8"},[t("div",Ve,[o[14]||(o[14]=t("div",{class:"bg-gradient-to-r from-indigo-500 to-indigo-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})]),f(" Información General ")])],-1)),t("div",$e,[t("div",null,[o[9]||(o[9]=t("label",{for:"numero_venta",class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},[f(" Número de Venta * "),t("span",{class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"},[t("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),f(" Número fijo ")])],-1)),t("div",Ae,[V(t("input",{id:"numero_venta","onUpdate:modelValue":o[0]||(o[0]=a=>c(r).numero_venta=a),type:"text",class:"w-full bg-gray-50 text-gray-500 cursor-not-allowed border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent",placeholder:"V0001",readonly:"",required:""},null,512),[[$,c(r).numero_venta]]),o[8]||(o[8]=t("div",{class:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"},[t("svg",{class:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})])],-1))]),o[10]||(o[10]=t("p",{class:"mt-1 text-xs text-gray-500"}," Este número es fijo para todas las ventas ",-1))]),t("div",null,[o[12]||(o[12]=t("label",{for:"fecha",class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},[f(" Fecha de Venta * "),t("span",{class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"},[t("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})]),f(" Automática ")])],-1)),t("div",Be,[V(t("input",{id:"fecha","onUpdate:modelValue":o[1]||(o[1]=a=>c(r).fecha=a),type:"date",class:"w-full bg-gray-50 text-gray-500 cursor-not-allowed border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent",readonly:"",required:""},null,512),[[$,c(r).fecha]]),o[11]||(o[11]=t("div",{class:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"},[t("svg",{class:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1))]),o[13]||(o[13]=t("p",{class:"mt-1 text-xs text-gray-500"}," Esta fecha se establece automáticamente con la fecha de creación ",-1))])])]),t("div",Ee,[o[15]||(o[15]=t("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})]),f(" Información del Cliente ")])],-1)),t("div",Le,[m(_e,{ref_key:"buscarClienteRef",ref:Q,clientes:j.value,"cliente-seleccionado":v.value,onClienteSeleccionado:L,onCrearNuevoCliente:X},null,8,["clientes","cliente-seleccionado"])])]),t("div",qe,[o[16]||(o[16]=t("div",{class:"bg-gradient-to-r from-green-500 to-green-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})]),f(" Productos y Servicios ")])],-1)),t("div",Ie,[m(Fe,{ref_key:"buscarProductoRef",ref:J,productos:k.productos,servicios:k.servicios,onAgregarProducto:oe},null,8,["productos","servicios"]),m(Se,{selectedProducts:s.value,productos:k.productos,servicios:k.servicios,quantities:u.value,prices:p.value,discounts:d.value,onEliminarProducto:te,onUpdateQuantity:re,onUpdateDiscount:se},null,8,["selectedProducts","productos","servicios","quantities","prices","discounts"])])]),t("div",De,[o[17]||(o[17]=t("div",{class:"bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})]),f(" Notas Adicionales ")])],-1)),t("div",ze,[V(t("textarea",{"onUpdate:modelValue":o[2]||(o[2]=a=>c(r).notas=a),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical",rows:"4",placeholder:"Agrega notas adicionales, términos y condiciones, o información relevante para la venta..."},null,512),[[$,c(r).notas]])])]),b.value?(R(),O("div",He,[t("div",Te,[o[21]||(o[21]=t("svg",{class:"w-5 h-5 text-yellow-600 mt-0.5 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"})],-1)),t("div",Ue,[o[20]||(o[20]=t("h3",{class:"text-sm font-medium text-yellow-800 mb-2"},"⚠️ Productos con margen insuficiente",-1)),t("div",Oe,be(h.value),1),t("div",{class:"flex gap-3"},[t("button",{onClick:le,class:"inline-flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-colors"},o[18]||(o[18]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})],-1),f(" Ajustar automáticamente ")])),t("button",{onClick:ie,class:"inline-flex items-center gap-2 px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"},o[19]||(o[19]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1),f(" Revisar precios ")]))])])])])):ge("",!0),m(ke,{"show-margin-calculator":!1,"margin-data":{costoTotal:0,precioVenta:0,ganancia:0,margenPorcentaje:0},totals:x.value,"item-count":s.value.length,"total-quantity":Object.values(u.value).reduce((a,l)=>a+(l||0),0),"onUpdate:descuentoGeneral":o[3]||(o[3]=a=>c(r).descuento_general=a)},null,8,["totals","item-count","total-quantity"]),m(Ce,{"back-url":e.route("ventas.index"),"is-processing":c(r).processing,"can-submit":c(r).cliente_id&&s.value.length>0,"button-text":c(r).processing?"Guardando...":"Crear Venta",onLimpiar:ae},null,8,["back-url","is-processing","can-submit","button-text"])],32),t("button",{onClick:o[4]||(o[4]=a=>F.value=!F.value),class:"fixed bottom-4 left-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200",title:"Mostrar atajos de teclado"},o[22]||(o[22]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)]))])]),m(je,{show:M.value,type:"venta",cliente:v.value,items:s.value,totals:x.value,notas:c(r).notas,onClose:o[5]||(o[5]=a=>M.value=!1),onPrint:o[6]||(o[6]=()=>e.window.print())},null,8,["show","cliente","items","totals","notas"]),m(Me,{show:N.value,catalogs:G.value,"nombre-inicial":B.value,onClose:o[7]||(o[7]=a=>N.value=!1),onClienteCreado:ee},null,8,["show","catalogs","nombre-inicial"])],64))}});export{to as default};
