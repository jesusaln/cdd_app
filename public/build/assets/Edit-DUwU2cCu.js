import{T as oe,r as f,p as te,c as se,i as I,o as T,g as m,f as s,u as g,Z as re,k as ie,q as ae,l as P,v as ne,z as le,F as de}from"./vendor-d19pJyVS.js";import{a as ce}from"./utils-Dq7h7Pqt.js";import{N as ue}from"./app-BcT2PLJy.js";import{A as pe}from"./AppLayout-CcnrZQKI.js";import{_ as ve,a as fe,b as me}from"./BotonesAccion-DYwTTkJE.js";import{_ as be}from"./BuscarCliente-t4xPlwkv.js";import{_ as ge}from"./BuscarProducto-B_taEjGP.js";import{P as he}from"./PySSeleccionados-5J0ZMOZn.js";import{_ as we}from"./VistaPreviaModal-CAwANwka.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const xe={class:"pedidos-edit min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6"},$e={class:"max-w-6xl mx-auto"},ke={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},ye={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ne={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},_e={class:"p-6"},Pe={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ce={class:"p-6"},Ee={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Fe={class:"p-6"},Ie=Object.assign({layout:pe},{__name:"Edit",props:{pedido:Object,clientes:Array,productos:Array,servicios:Array},setup(h){var M,z,S,A,V,D,q,O;const B=new ue({duration:5e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10B981",icon:{className:"notyf__icon--success",tagName:"i",text:"✓"}},{type:"error",background:"#EF4444",icon:{className:"notyf__icon--error",tagName:"i",text:"✗"}},{type:"info",background:"#3B82F6",icon:{className:"notyf__icon--info",tagName:"i",text:"ℹ"}}]}),r=(e,o="success")=>{B.open({type:o,message:e})},c=h,l=oe({cliente_id:((z=(M=c.pedido)==null?void 0:M.cliente)==null?void 0:z.id)||"",numero_pedido:((S=c.pedido)==null?void 0:S.numero_pedido)||"",subtotal:((A=c.pedido)==null?void 0:A.subtotal)||0,iva:((V=c.pedido)==null?void 0:V.iva)||0,total:((D=c.pedido)==null?void 0:D.total)||0,productos:[],notas:((q=c.pedido)==null?void 0:q.notas)||""}),n=f([]),p=f({}),b=f({}),v=f({}),w=f(((O=c.pedido)==null?void 0:O.cliente)||null),k=f(!1),$=f(!0),y=f(!1),C=(e,o=0)=>{const t=parseFloat(e);return!isNaN(t)&&t>=o},E=e=>C(e,.01),L=e=>C(e,0),F=e=>{const o=parseFloat(e);return!isNaN(o)&&o>=0&&o<=100};te(()=>{var e;(e=c.pedido)!=null&&e.productos&&(c.pedido.productos.forEach(o=>{var i,d,a;const t=`${o.tipo}-${o.id}`;n.value.push({id:o.id,tipo:o.tipo}),p.value[t]=((i=o.pivot)==null?void 0:i.cantidad)||1,b.value[t]=((d=o.pivot)==null?void 0:d.precio)||0,v.value[t]=((a=o.pivot)==null?void 0:a.descuento)||0}),x())});const Q=()=>{w.value&&n.value.length>0?k.value=!0:r("Selecciona un cliente y al menos un producto","error")},U=()=>{$.value=!1},j=e=>{if(!e){w.value=null,l.cliente_id="",r("Cliente eliminado","info");return}w.value=e,l.cliente_id=e.id,r(`Cliente: ${e.nombre_razon_social||e.nombre||"Sin nombre"}`)},R=async e=>{var o,t,i,d;if(!(e!=null&&e.trim())){r("El nombre del cliente es requerido","error");return}y.value=!0;try{if(typeof route!="function")throw new Error("Route helper no está disponible");const a=await ce.post(route("clientes.store"),{nombre_razon_social:e.trim()});if(a.data){const u=a.data;c.clientes.push(u),j(u),r(`Cliente creado: ${u.nombre_razon_social||u.nombre||"Sin nombre"}`)}}catch(a){if(console.error("Error al crear cliente:",a),((o=a.response)==null?void 0:o.status)===422){const u=(t=a.response.data)==null?void 0:t.errors;if(u){const _=Object.values(u).flat().join(", ");r(`Errores de validación: ${_}`,"error")}else r("Datos de cliente inválidos","error")}else((i=a.response)==null?void 0:i.status)===409?r("Ya existe un cliente con ese nombre","error"):((d=a.response)==null?void 0:d.status)>=500?r("Error del servidor. Intenta nuevamente","error"):r("No se pudo crear el cliente","error")}finally{y.value=!1}},G=e=>{if(!(e!=null&&e.id)||!(e!=null&&e.tipo)){r("Producto inválido","error");return}const o={id:e.id,tipo:e.tipo};if(n.value.some(i=>i.id===e.id&&i.tipo===e.tipo)){const i=e.nombre||e.descripcion||e.titulo||`${e.tipo} ${e.id}`;r(`${i} ya está agregado`,"info")}else{n.value.push(o);const i=`${e.tipo}-${e.id}`;p.value[i]=1;let d=0;e.tipo==="producto"?d=e.precio_venta||e.precio||0:e.tipo==="servicio"&&(d=e.precio||e.precio_venta||0),b.value[i]=d,v.value[i]=0,x();const a=e.nombre||e.descripcion||e.titulo||`${e.tipo} ${e.id}`;r(`Añadido: ${a}`)}},Y=e=>{if(!(e!=null&&e.id)||!(e!=null&&e.tipo)){r("Error al eliminar producto","error");return}const o=`${e.tipo}-${e.id}`;n.value=n.value.filter(i=>!(i.id===e.id&&i.tipo===e.tipo)),delete p.value[o],delete b.value[o],delete v.value[o],x();const t=e.nombre||e.descripcion||e.titulo||`${e.tipo} ${e.id}`;r(`Eliminado: ${t}`,"info")},Z=(e,o)=>{if(!E(o)){r("La cantidad debe ser mayor a 0","error");return}p.value[e]=parseFloat(o),x()},J=(e,o)=>{if(!F(o)){r("El descuento debe estar entre 0% y 100%","error");return}v.value[e]=parseFloat(o),x()},N=se(()=>{let e=0,o=0;n.value.forEach(a=>{const u=`${a.tipo}-${a.id}`,_=parseFloat(p.value[u])||0,W=parseFloat(b.value[u])||0,X=parseFloat(v.value[u])||0,H=_*W,ee=H*(X/100);e+=H,o+=ee});const t=e-o,i=t*.16,d=t+i;return{subtotal:Number(e.toFixed(2)),descuentoItems:Number(o.toFixed(2)),subtotalConDescuentos:Number(t.toFixed(2)),iva:Number(i.toFixed(2)),total:Number(d.toFixed(2))}}),x=()=>{const e=N.value;l.subtotal=e.subtotal,l.iva=e.iva,l.total=e.total},K=()=>{var e;if(!l.cliente_id){r("Selecciona un cliente","error");return}if(n.value.length===0){r("Agrega al menos un producto o servicio","error");return}for(const o of n.value){const t=`${o.tipo}-${o.id}`,i=p.value[t],d=b.value[t],a=v.value[t]||0;if(!E(i)){r(`Cantidad inválida para ${o.tipo} ${o.id}`,"error");return}if(!L(d)){r(`Precio inválido para ${o.tipo} ${o.id}`,"error");return}if(!F(a)){r(`Descuento inválido para ${o.tipo} ${o.id}`,"error");return}}if(l.productos=n.value.map(o=>{const t=`${o.tipo}-${o.id}`;return{id:o.id,tipo:o.tipo,cantidad:parseFloat(p.value[t])||1,precio:parseFloat(b.value[t])||0,descuento:parseFloat(v.value[t])||0}}),x(),typeof route!="function"){r("Error del sistema: Route helper no disponible","error");return}l.put(route("pedidos.update",(e=c.pedido)==null?void 0:e.id),{onSuccess:()=>{r("Pedido actualizado con éxito")},onError:o=>{if(console.error("Errores de validación:",o),typeof o=="object"&&o!==null){const t=Object.values(o).flat().join(", ");r(`Errores: ${t}`,"error")}else r("Hubo errores al actualizar el pedido","error")}})};return(e,o)=>(T(),I(de,null,[m(g(re),{title:"Editar Pedido"}),s("div",xe,[s("div",$e,[y.value?(T(),I("div",ke,o[4]||(o[4]=[s("div",{class:"bg-white rounded-lg p-6 flex items-center space-x-3"},[s("div",{class:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),s("span",{class:"text-gray-700"},"Procesando...")],-1)]))):ie("",!0),s("div",ye,[m(ve,{title:"Editar Pedido",description:"Modifica los detalles del pedido","can-preview":w.value&&n.value.length>0,"back-url":e.route&&e.route("pedidos.index"),"show-shortcuts":$.value,onPreview:Q,onCloseShortcuts:U},null,8,["can-preview","back-url","show-shortcuts"])]),s("form",{onSubmit:ae(K,["prevent"]),class:"space-y-8 mt-6"},[s("div",Ne,[o[5]||(o[5]=s("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4"},[s("h2",{class:"text-lg font-semibold text-white flex items-center"},[s("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})]),P(" Cliente ")])],-1)),s("div",_e,[m(be,{clientes:h.clientes,"cliente-seleccionado":w.value,onClienteSeleccionado:j,onCrearNuevoCliente:R},null,8,["clientes","cliente-seleccionado"])])]),s("div",Pe,[o[6]||(o[6]=s("div",{class:"bg-gradient-to-r from-green-500 to-green-600 px-6 py-4"},[s("h2",{class:"text-lg font-semibold text-white flex items-center"},[s("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})]),P(" Productos y Servicios ")])],-1)),s("div",Ce,[m(ge,{productos:h.productos,servicios:h.servicios,onAgregarProducto:G},null,8,["productos","servicios"]),m(he,{selectedProducts:n.value,productos:h.productos,servicios:h.servicios,quantities:p.value,prices:b.value,discounts:v.value,onEliminarProducto:Y,onUpdateQuantity:Z,onUpdateDiscount:J},null,8,["selectedProducts","productos","servicios","quantities","prices","discounts"])])]),s("div",Ee,[o[7]||(o[7]=s("div",{class:"bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4"},[s("h2",{class:"text-lg font-semibold text-white flex items-center"},[s("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})]),P(" Notas Adicionales ")])],-1)),s("div",Fe,[ne(s("textarea",{"onUpdate:modelValue":o[0]||(o[0]=t=>g(l).notas=t),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical",rows:"4",placeholder:"Agrega notas adicionales, términos y condiciones, o información relevante para el pedido..."},null,512),[[le,g(l).notas]])])]),m(fe,{"show-margin-calculator":!1,"margin-data":{costoTotal:0,precioVenta:0,ganancia:0,margenPorcentaje:0},totals:N.value,"item-count":n.value.length,"total-quantity":Object.values(p.value).reduce((t,i)=>t+(parseFloat(i)||0),0)},null,8,["totals","item-count","total-quantity"]),m(me,{"back-url":e.route&&e.route("pedidos.index"),"is-processing":g(l).processing,"can-submit":g(l).cliente_id&&n.value.length>0,"button-text":g(l).processing?"Guardando...":"Actualizar Pedido"},null,8,["back-url","is-processing","can-submit","button-text"])],32),s("button",{onClick:o[1]||(o[1]=t=>$.value=!$.value),class:"fixed bottom-4 left-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200",title:"Mostrar/Ocultar atajos de teclado"},o[8]||(o[8]=[s("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)]))]),m(we,{show:k.value,type:"pedido",cliente:w.value,items:n.value,totals:N.value,notas:g(l).notas,onClose:o[2]||(o[2]=t=>k.value=!1),onPrint:o[3]||(o[3]=()=>e.window.print())},null,8,["show","cliente","items","totals","notas"])])],64))}});export{Ie as default};
