import{T as L,r as p,p as U,c as Q,i as H,o as J,g as f,f as a,u as m,Z,q as K,l as S,v as R,z as W,F as X}from"./vendor-d19pJyVS.js";import{N as Y}from"./app-BcT2PLJy.js";import{A as ee}from"./AppLayout-CcnrZQKI.js";import{_ as oe,a as te,b as ae}from"./BotonesAccion-DYwTTkJE.js";import{_ as se}from"./BuscarCliente-t4xPlwkv.js";import{_ as re}from"./BuscarProducto-B_taEjGP.js";import{P as ne}from"./PySSeleccionados-5J0ZMOZn.js";import{_ as le}from"./VistaPreviaModal-CAwANwka.js";import{_ as ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./utils-Dq7h7Pqt.js";const ce={class:"ventas-edit min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6"},ue={class:"max-w-6xl mx-auto"},de={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},ve={class:"p-6"},pe={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},fe={class:"p-6"},ge={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},be={class:"p-6"},me=Object.assign({layout:ee},{__name:"Edit",props:{venta:{type:Object,required:!0},clientes:{type:Array,required:!0},productos:{type:Array,default:()=>[]},servicios:{type:Array,default:()=>[]}},setup(x){const l=x,r=new Y({duration:4e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10b981",icon:!1},{type:"error",background:"#ef4444",icon:!1},{type:"info",background:"#3b82f6",icon:!1}]}),t=L({cliente_id:l.venta.cliente.id,numero_venta:l.venta.numero_venta,fecha:l.venta.fecha,estado:l.venta.estado,descuento_general:l.venta.descuento_general||0,productos:[],notas:l.venta.notas||""}),V=p([...l.clientes]),n=p([]),i=p({}),u=p({}),d=p({}),g=p(l.venta.cliente),k=p(!1),F=p(!0);U(()=>{console.log("Cargando venta desde base de datos:",l.venta),l.venta.items.forEach(e=>{const o=e.ventable_type==="App\\Models\\Producto"?"producto":"servicio",s=`${o}-${e.ventable.id}`;n.value.push({id:e.ventable.id,tipo:o}),i.value[s]=e.cantidad,u.value[s]=e.precio,d.value[s]=e.descuento||0}),w(),r.open({type:"info",message:"Datos cargados desde la base de datos"})});const E=e=>{if(!e){g.value=null,t.cliente_id="",r.info("Cliente eliminado");return}g.value=e,t.cliente_id=e.id,r.success(`Cliente: ${e.nombre_razon_social||e.nombre}`),y()},A=e=>{if(!(e!=null&&e.id)||!(e!=null&&e.tipo)){r.error("Producto inválido");return}const o=`${e.tipo}-${e.id}`;n.value=n.value.filter(s=>!(s.id===e.id&&s.tipo===e.tipo)),delete i.value[o],delete u.value[o],delete d.value[o],r.info("Producto eliminado"),y()},M=e=>{if(!e||!e.id||!e.tipo){r.error("Producto inválido");return}const o=`${e.tipo}-${e.id}`;if(n.value.some(b=>b.id===e.id&&b.tipo===e.tipo)){const b=e.nombre||e.descripcion||e.titulo||`Elemento ${e.id}`;r.info(`${b} ya está agregado`);return}n.value.push({id:e.id,tipo:e.tipo}),i.value[o]=1;let c=0;e.tipo==="producto"?c=e.precio_venta||e.precio||0:e.tipo==="servicio"&&(c=e.precio||e.precio_venta||0),u.value[o]=c,d.value[o]=0;const v=e.nombre||e.descripcion||e.titulo||`Nuevo ${e.tipo}`;r.success(`✅ ${v} agregado`),w(),y()},h=Q(()=>{let e=0;n.value.forEach($=>{const _=`${$.tipo}-${$.id}`,P=parseFloat(i.value[_])||0,C=parseFloat(u.value[_])||0,D=P*C;e+=D});const o=parseFloat(t.descuento_general)||0,s=e-o;let c=0;n.value.forEach($=>{const _=`${$.tipo}-${$.id}`,P=parseFloat(i.value[_])||0,C=parseFloat(u.value[_])||0,D=parseFloat(d.value[_])||0,G=P*C*(D/100);c+=G});const v=s-c,b=v,N=b*.16,T=b+N;return{subtotal:parseFloat(e.toFixed(2)),descuento_items:parseFloat(c.toFixed(2)),descuento_general:parseFloat(o.toFixed(2)),subtotalConDescuentos:parseFloat(v.toFixed(2)),iva:parseFloat(N.toFixed(2)),total:parseFloat(T.toFixed(2))}}),w=()=>{const e=h.value;t.subtotal=e.subtotal,t.iva=e.iva,t.total=e.total,t.descuento_general=e.descuento_general},q=()=>{if(!t.cliente_id){r.error("Selecciona un cliente");return}if(n.value.length===0){r.error("Agrega al menos un producto o servicio");return}for(const e of n.value){const o=`${e.tipo}-${e.id}`,s=parseFloat(i.value[o]),c=parseFloat(u.value[o]),v=parseFloat(d.value[o])||0;if(isNaN(s)||s<=0){r.error(`Cantidad inválida para el producto ID: ${e.id}`);return}if(isNaN(c)||c<0){r.error(`Precio inválido para el producto ID: ${e.id}`);return}if(isNaN(v)||v<0||v>100){r.error(`Descuento inválido para el producto ID: ${e.id}`);return}}t.productos=n.value.map(e=>{const o=`${e.tipo}-${e.id}`;return{id:e.id,tipo:e.tipo,cantidad:parseFloat(i.value[o])||1,precio:parseFloat(u.value[o])||0,descuento:parseFloat(d.value[o])||0}}),w(),t.put(route("ventas.update",l.venta.id),{onSuccess:()=>{localStorage.removeItem(`venta_edit_${l.venta.id}`),r.success("✅ Venta actualizada correctamente")},onError:e=>{console.error("Errores de validación:",e);const o=Object.values(e)[0];r.error(Array.isArray(o)?o[0]:o)}})},I=()=>{if(!g.value||n.value.length===0){r.error("Completa cliente y productos");return}k.value=!0},j=async()=>{const e={...l.venta,cliente:g.value,productos:n.value.map(o=>{const s=`${o.tipo}-${o.id}`;return{...o,cantidad:i.value[s],precio:u.value[s],descuento:d.value[s]||0}}),subtotal:h.value.subtotal,descuento_general:t.descuento_general,iva:h.value.iva,total:h.value.total,fecha:t.fecha,numero_venta:t.numero_venta,notas:t.notas};try{r.success("📄 Generando PDF..."),await generarPDF("Venta",e),r.success("✅ PDF generado")}catch(o){r.error("❌ Error al generar PDF"),console.error(o)}},z=()=>{F.value=!1},y=()=>{const e={cliente_id:t.cliente_id,selectedProducts:n.value,quantities:i.value,prices:u.value,discounts:d.value,descuento_general:t.descuento_general,notas:t.notas};localStorage.setItem(`venta_edit_${l.venta.id}`,JSON.stringify(e))},B=(e,o)=>{i.value[e]=o,w(),y()},O=(e,o)=>{d.value[e]=o,w(),y()};return(e,o)=>(J(),H(X,null,[f(m(Z),{title:"Editar Venta"}),a("div",ce,[a("div",ue,[f(oe,{title:"Editar Venta",description:"Modifica los detalles de la venta","can-preview":g.value&&n.value.length>0,"back-url":e.route("ventas.index"),onPreview:I,"show-shortcuts":F.value,onCloseShortcuts:z},null,8,["can-preview","back-url","show-shortcuts"]),a("form",{onSubmit:K(q,["prevent"]),class:"space-y-8"},[a("div",de,[o[3]||(o[3]=a("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4"},[a("h2",{class:"text-lg font-semibold text-white flex items-center"},[a("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})]),S(" Cliente ")])],-1)),a("div",ve,[f(se,{clientes:V.value,"cliente-seleccionado":g.value,onClienteSeleccionado:E},null,8,["clientes","cliente-seleccionado"])])]),a("div",pe,[o[4]||(o[4]=a("div",{class:"bg-gradient-to-r from-green-500 to-green-600 px-6 py-4"},[a("h2",{class:"text-lg font-semibold text-white flex items-center"},[a("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})]),S(" Productos y Servicios ")])],-1)),a("div",fe,[f(re,{productos:x.productos,servicios:x.servicios,onAgregarProducto:M},null,8,["productos","servicios"]),f(ne,{selectedProducts:n.value,productos:x.productos,servicios:x.servicios,quantities:i.value,prices:u.value,discounts:d.value,onEliminarProducto:A,onUpdateQuantity:B,onUpdateDiscount:O},null,8,["selectedProducts","productos","servicios","quantities","prices","discounts"])])]),a("div",ge,[o[5]||(o[5]=a("div",{class:"px-6 py-4 bg-gray-50 border-b"},[a("h2",{class:"text-lg font-semibold text-gray-800"},"Notas (Opcional)")],-1)),a("div",be,[R(a("textarea",{"onUpdate:modelValue":o[0]||(o[0]=s=>m(t).notas=s),rows:"3",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500",placeholder:"Notas adicionales para la venta..."},null,512),[[W,m(t).notas]])])]),f(te,{"show-margin-calculator":!1,"margin-data":{costoTotal:0,precioVenta:0,ganancia:0,margenPorcentaje:0},totals:h.value,"item-count":n.value.length,"total-quantity":Object.values(i.value).reduce((s,c)=>s+(parseFloat(c)||0),0)},null,8,["totals","item-count","total-quantity"]),f(ae,{"back-url":e.route("ventas.index"),"is-processing":m(t).processing,"can-submit":m(t).cliente_id&&n.value.length>0,"button-text":m(t).processing?"Guardando...":"Actualizar Venta"},null,8,["back-url","is-processing","can-submit","button-text"])],32),a("button",{onClick:o[1]||(o[1]=s=>F.value=!F.value),class:"fixed bottom-4 left-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200",title:"Mostrar atajos de teclado"},o[6]||(o[6]=[a("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)])),f(le,{show:k.value,type:"venta",cliente:g.value,items:n.value,quantities:i.value,prices:u.value,discounts:d.value,totals:h.value,notas:m(t).notas,onClose:o[2]||(o[2]=s=>k.value=!1),onPrint:j},null,8,["show","cliente","items","quantities","prices","discounts","totals","notas"])])])],64))}}),Ne=ie(me,[["__scopeId","data-v-832300a6"]]);export{Ne as default};
