import{c as B,r as l,T as de,p as ve,O as pe,i as fe,o as me,g as f,f as t,u as v,Z as ge,q as be,l as m,v as V,z as I,F as he}from"./vendor-d19pJyVS.js";import{N as xe}from"./app-BcT2PLJy.js";import{A as ye}from"./AppLayout-CcnrZQKI.js";import{_ as we,a as _e,b as ze}from"./BotonesAccion-DYwTTkJE.js";import{_ as ke}from"./BuscarCliente-t4xPlwkv.js";import{_ as Ce}from"./BuscarProducto-B_taEjGP.js";import{P as je}from"./PySSeleccionados-5J0ZMOZn.js";import{_ as Fe}from"./VistaPreviaModal-CAwANwka.js";import{_ as Se}from"./MarginAlertModal-CSRzALEf.js";import{_ as Ae}from"./CrearClienteModal-B7UwTQZh.js";import"./utils-Dq7h7Pqt.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Modal-DXOFbFUN.js";import"./PrimaryButton-D_2lIeSZ.js";import"./SecondaryButton-BHgzZ2Qe.js";const Ne={class:"cotizaciones-create min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6"},Pe={class:"max-w-6xl mx-auto"},$e={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ee={class:"p-6 grid grid-cols-1 md:grid-cols-2 gap-6"},Me={class:"relative"},Be={class:"relative"},Ve={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ie={class:"p-6"},Le={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},qe={class:"p-6"},De={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Te={class:"p-6"},w="COT0001",ao=Object.assign({layout:ye},{__name:"Create",props:{clientes:Array,productos:{type:Array,default:()=>[]},servicios:{type:Array,default:()=>[]},catalogs:{type:Object,default:()=>({})}},setup(y){const L=new xe({duration:5e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10B981",icon:{className:"notyf__icon--success",tagName:"i",text:"✓"}},{type:"error",background:"#EF4444",icon:{className:"notyf__icon--error",tagName:"i",text:"✗"}},{type:"info",background:"#3B82F6",icon:{className:"notyf__icon--info",tagName:"i",text:"ℹ"}}]}),s=(e,o="success")=>{L.open({type:o,message:e})},S=y,_=B(()=>S.clientes.filter(e=>{const o=e.estado||e.status||e.activo;return typeof o=="string"?o.toLowerCase()==="activo"||o.toLowerCase()==="active":typeof o=="boolean"?o===!0:typeof o=="number"?o===1:!0})),R=B(()=>S.catalogs),A=l([]),z=()=>{const e=new Date,o=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${o}-${a}-${i}`},r=de({numero_cotizacion:w,fecha_cotizacion:z(),cliente_id:"",subtotal:0,descuento_items:0,iva:0,total:0,productos:[],notas:"",estado:"borrador"}),G=l(null),Q=l(null),n=l([]),c=l({}),p=l({}),d=l({}),u=l(null),N=l(!1),k=l(!0),C=l(!1),j=l([]),P=l(!1),$=l(!1),q=l(""),J=(e,o)=>{try{localStorage.setItem(e,JSON.stringify(o))}catch(a){console.warn("No se pudo guardar en localStorage:",a)}},Y=e=>{try{const o=localStorage.getItem(e);return o?JSON.parse(o):null}catch(o){return console.warn("No se pudo cargar desde localStorage:",o),null}},E=e=>{try{localStorage.removeItem(e)}catch(o){console.warn("No se pudo eliminar de localStorage:",o)}},Z=()=>{u.value&&n.value.length>0?N.value=!0:s("Selecciona un cliente y al menos un producto","error")},K=()=>{k.value=!1},D=e=>{var o;if(!e){u.value=null,r.cliente_id="",x(),s("Selección de cliente limpiada","info");return}((o=u.value)==null?void 0:o.id)!==e.id&&(u.value=e,r.cliente_id=e.id,x(),s(`Cliente seleccionado: ${e.nombre_razon_social}`))},W=e=>{q.value=e,$.value=!0},X=e=>{e.estado==="activo"||e.estado==="Activo"||e.estado===!0||e.estado===1?(A.value.some(o=>o.id===e.id)||A.value.push(e),D(e)):s("No se puede seleccionar un cliente inactivo","error")},ee=()=>{var e;u.value=null,r.cliente_id="",n.value=[],c.value={},p.value={},d.value={},r.notas="",r.numero_cotizacion=w,r.fecha_cotizacion=z(),localStorage.removeItem(`cotizacion_edit_${(e=S.cotizacion)==null?void 0:e.id}`),L.success("Formulario limpiado correctamente")},oe=e=>{if(!e||typeof e.id>"u"||!e.tipo){s("Producto inválido","error");return}const o={id:e.id,tipo:e.tipo};if(!n.value.some(i=>i.id===e.id&&i.tipo===e.tipo)){n.value.push(o);const i=`${e.tipo}-${e.id}`;c.value[i]=1;let g=0;e.tipo==="producto"?g=typeof e.precio_venta=="number"?e.precio_venta:0:g=typeof e.precio=="number"?e.precio:0,p.value[i]=g,d.value[i]=0,h(),x(),s(`Producto añadido: ${e.nombre||e.descripcion||"Item"}`)}},te=e=>{if(!e||typeof e.id>"u"||!e.tipo)return;const o=`${e.tipo}-${e.id}`;n.value=n.value.filter(a=>!(a.id===e.id&&a.tipo===e.tipo)),delete c.value[o],delete p.value[o],delete d.value[o],h(),x(),s(`Producto eliminado: ${e.nombre||e.descripcion||"Item"}`,"info")},ae=(e,o)=>{const a=parseFloat(o);isNaN(a)||a<0||(c.value[e]=a,h(),x())},re=(e,o)=>{const a=parseFloat(o);isNaN(a)||a<0||a>100||(d.value[e]=a,h(),x())},b=B(()=>{let e=0,o=0;n.value.forEach(F=>{const M=`${F.tipo}-${F.id}`,H=parseFloat(c.value[M])||0,O=parseFloat(p.value[M])||0,ue=parseFloat(d.value[M])||0;if(H>0&&O>=0){const U=H*O;o+=U*(ue/100),e+=U}});const a=Math.max(0,e-o),i=a*.16,g=a+i;return{subtotal:parseFloat(e.toFixed(2)),descuentoItems:parseFloat(o.toFixed(2)),subtotalConDescuentos:parseFloat(a.toFixed(2)),iva:parseFloat(i.toFixed(2)),total:parseFloat(g.toFixed(2))}}),h=()=>{r.subtotal=b.value.subtotal,r.descuento_items=b.value.descuentoItems,r.iva=b.value.iva,r.total=b.value.total},se=()=>{if(!r.cliente_id)return!1;if(!_.value.find(o=>o.id===r.cliente_id))return s("El cliente seleccionado no está activo","error"),u.value=null,r.cliente_id="",!1;if(n.value.length===0)return s("Agrega al menos un producto o servicio","error"),!1;for(const o of n.value){const a=`${o.tipo}-${o.id}`,i=parseFloat(d.value[a])||0,g=parseFloat(c.value[a])||0,F=parseFloat(p.value[a])||0;if(i<0||i>100)return s("Los descuentos deben estar entre 0% y 100%.","error"),!1;if(g<=0)return s("Las cantidades deben ser mayores a 0","error"),!1;if(F<0)return s("Los precios no pueden ser negativos","error"),!1}return!0},ne=()=>{se()&&(r.productos=n.value.map(e=>{const o=`${e.tipo}-${e.id}`;return{id:e.id,tipo:e.tipo,cantidad:parseFloat(c.value[o])||1,precio:parseFloat(p.value[o])||0,descuento:parseFloat(d.value[o])||0}}),h(),r.estado="borrador",r.post(route("cotizaciones.store"),{onSuccess:e=>{var o,a;if((o=e.props.flash)!=null&&o.warning&&((a=e.props.flash)!=null&&a.requiere_confirmacion_margen)){j.value=e.props.flash.productos_bajo_margen||[],C.value=!0;return}E("cotizacionEnProgreso"),n.value=[],c.value={},p.value={},d.value={},u.value=null,r.reset(),s("Cotización creada con éxito")},onError:e=>{console.error("Errores de validación:",e);const o=Object.values(e)[0];Array.isArray(o)?s(o[0],"error"):s("Hubo errores de validación","error")}}))},T=e=>{(r.cliente_id||n.value.length>0)&&(e.preventDefault(),e.returnValue="Tienes cambios sin guardar. ¿Estás seguro de que quieres salir?")},x=()=>{const e={numero_cotizacion:w,fecha_cotizacion:r.fecha_cotizacion,cliente_id:r.cliente_id,cliente:u.value,selectedProducts:n.value,quantities:c.value,prices:p.value,discounts:d.value};J("cotizacionEnProgreso",e)},ie=()=>{const e=z();r.fecha_cotizacion!==e&&(r.fecha_cotizacion=e)};ve(()=>{A.value=[..._.value],s(`Número de cotización fijo: ${w}`,"info");const e=Y("cotizacionEnProgreso");if(e&&typeof e=="object")try{r.numero_cotizacion=w,r.fecha_cotizacion=z(),e.cliente_id&&e.cliente&&(_.value.find(a=>a.id===e.cliente_id)?(r.cliente_id=e.cliente_id,u.value=e.cliente):s("El cliente guardado ya no está activo","info")),n.value=Array.isArray(e.selectedProducts)?e.selectedProducts:[],c.value=e.quantities||{},p.value=e.prices||{},d.value=e.discounts||{},h()}catch(o){console.warn("Error al cargar datos guardados:",o),E("cotizacionEnProgreso")}setInterval(()=>{ie()},5*60*1e3),window.addEventListener("beforeunload",T)}),pe(()=>{window.removeEventListener("beforeunload",T),typeof fechaInterval<"u"&&clearInterval(fechaInterval)});const le=()=>{C.value=!1,j.value=[]},ce=async()=>{P.value=!0;try{r.ajustar_margen=!0,r.post(route("cotizaciones.store"),{onSuccess:()=>{E("cotizacionEnProgreso"),n.value=[],c.value={},p.value={},d.value={},u.value=null,r.reset(),C.value=!1,j.value=[],s("Cotización creada con precios ajustados automáticamente")},onError:e=>{console.error("Errores al ajustar precios:",e),s("Error al ajustar precios automáticamente","error")}})}catch(e){console.error("Error al ajustar precios:",e),s("Error al procesar el ajuste automático","error")}finally{P.value=!1}};return(e,o)=>(me(),fe(he,null,[f(v(ge),{title:"Crear cotización"}),t("div",Ne,[t("div",Pe,[f(we,{title:"Nueva Cotización",description:"Crea una nueva cotización para tus clientes","can-preview":u.value&&n.value.length>0,"back-url":e.route("cotizaciones.index"),"show-shortcuts":k.value,onPreview:Z,onCloseShortcuts:K},null,8,["can-preview","back-url","show-shortcuts"]),t("form",{onSubmit:be(ne,["prevent"]),class:"space-y-8"},[t("div",$e,[o[14]||(o[14]=t("div",{class:"bg-gradient-to-r from-indigo-500 to-indigo-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})]),m(" Información General ")])],-1)),t("div",Ee,[t("div",null,[o[9]||(o[9]=t("label",{for:"numero_cotizacion",class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},[m(" Número de Cotización * "),t("span",{class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"},[t("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),m(" Número fijo ")])],-1)),t("div",Me,[V(t("input",{id:"numero_cotizacion","onUpdate:modelValue":o[0]||(o[0]=a=>v(r).numero_cotizacion=a),type:"text",class:"w-full bg-gray-50 text-gray-500 cursor-not-allowed border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent",placeholder:"COT0001",readonly:"",required:""},null,512),[[I,v(r).numero_cotizacion]]),o[8]||(o[8]=t("div",{class:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"},[t("svg",{class:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})])],-1))]),o[10]||(o[10]=t("p",{class:"mt-1 text-xs text-gray-500"}," Este número es fijo para todas las cotizaciones ",-1))]),t("div",null,[o[12]||(o[12]=t("label",{for:"fecha_cotizacion",class:"block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2"},[m(" Fecha de Cotización * "),t("span",{class:"inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full"},[t("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})]),m(" Automática ")])],-1)),t("div",Be,[V(t("input",{id:"fecha_cotizacion","onUpdate:modelValue":o[1]||(o[1]=a=>v(r).fecha_cotizacion=a),type:"date",class:"w-full bg-gray-50 text-gray-500 cursor-not-allowed border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent",readonly:"",required:""},null,512),[[I,v(r).fecha_cotizacion]]),o[11]||(o[11]=t("div",{class:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"},[t("svg",{class:"w-5 h-5 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1))]),o[13]||(o[13]=t("p",{class:"mt-1 text-xs text-gray-500"}," Esta fecha se establece automáticamente con la fecha de creación ",-1))])])]),t("div",Ve,[o[15]||(o[15]=t("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})]),m(" Información del Cliente ")])],-1)),t("div",Ie,[f(ke,{ref_key:"buscarClienteRef",ref:G,clientes:_.value,"cliente-seleccionado":u.value,onClienteSeleccionado:D,onCrearNuevoCliente:W},null,8,["clientes","cliente-seleccionado"])])]),t("div",Le,[o[16]||(o[16]=t("div",{class:"bg-gradient-to-r from-green-500 to-green-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})]),m(" Productos y Servicios ")])],-1)),t("div",qe,[f(Ce,{ref_key:"buscarProductoRef",ref:Q,productos:y.productos,servicios:y.servicios,onAgregarProducto:oe},null,8,["productos","servicios"]),f(je,{selectedProducts:n.value,productos:y.productos,servicios:y.servicios,quantities:c.value,prices:p.value,discounts:d.value,onEliminarProducto:te,onUpdateQuantity:ae,onUpdateDiscount:re},null,8,["selectedProducts","productos","servicios","quantities","prices","discounts"])])]),t("div",De,[o[17]||(o[17]=t("div",{class:"bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})]),m(" Notas Adicionales ")])],-1)),t("div",Te,[V(t("textarea",{"onUpdate:modelValue":o[2]||(o[2]=a=>v(r).notas=a),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical",rows:"4",placeholder:"Agrega notas adicionales, términos y condiciones, o información relevante para la cotización..."},null,512),[[I,v(r).notas]])])]),f(_e,{"show-margin-calculator":!1,"margin-data":{costoTotal:0,precioVenta:0,ganancia:0,margenPorcentaje:0},totals:b.value,"item-count":n.value.length,"total-quantity":Object.values(c.value).reduce((a,i)=>a+(i||0),0),"onUpdate:descuentoGeneral":o[3]||(o[3]=a=>v(r).descuento_general=a)},null,8,["totals","item-count","total-quantity"]),f(ze,{"back-url":e.route("cotizaciones.index"),"is-processing":v(r).processing,"can-submit":v(r).cliente_id&&n.value.length>0,"button-text":v(r).processing?"Guardando...":"Crear Cotización",onLimpiar:ee},null,8,["back-url","is-processing","can-submit","button-text"])],32),t("button",{onClick:o[4]||(o[4]=a=>k.value=!k.value),class:"fixed bottom-4 left-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200",title:"Mostrar atajos de teclado"},o[18]||(o[18]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)]))])]),f(Fe,{show:N.value,type:"cotizacion",cliente:u.value,items:n.value,totals:b.value,notas:v(r).notas,onClose:o[5]||(o[5]=a=>N.value=!1),onPrint:o[6]||(o[6]=()=>e.window.print())},null,8,["show","cliente","items","totals","notas"]),f(Se,{show:C.value,"productos-bajo-margen":j.value,processing:P.value,onClose:le,onAjustarAutomaticamente:ce},null,8,["show","productos-bajo-margen","processing"]),f(Ae,{show:$.value,catalogs:R.value,"nombre-inicial":q.value,onClose:o[7]||(o[7]=a=>$.value=!1),onClienteCreado:X},null,8,["show","catalogs","nombre-inicial"])],64))}});export{ao as default};
