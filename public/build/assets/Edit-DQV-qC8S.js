import{T as so,r as p,p as io,c as no,i as T,o as L,g as f,f as a,u as g,Z as lo,k as co,q as uo,l as E,v as po,z as vo,F as fo}from"./vendor-d19pJyVS.js";import{a as mo}from"./utils-Dq7h7Pqt.js";import{N as bo}from"./app-BcT2PLJy.js";import{A as go}from"./AppLayout-CcnrZQKI.js";import{_ as ho,a as wo,b as xo}from"./BotonesAccion-DYwTTkJE.js";import{_ as zo}from"./BuscarCliente-t4xPlwkv.js";import{_ as $o}from"./BuscarProducto-B_taEjGP.js";import{P as yo}from"./PySSeleccionados-5J0ZMOZn.js";import{_ as _o}from"./VistaPreviaModal-CAwANwka.js";import{_ as ko}from"./MarginAlertModal-CSRzALEf.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Modal-DXOFbFUN.js";import"./PrimaryButton-D_2lIeSZ.js";import"./SecondaryButton-BHgzZ2Qe.js";const No={class:"cotizaciones-edit min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6"},jo={class:"max-w-6xl mx-auto"},Co={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Eo={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Po={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Fo={class:"p-6"},Mo={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Ao={class:"p-6"},So={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Vo={class:"p-6"},Jo=Object.assign({layout:go},{__name:"Edit",props:{cotizacion:Object,clientes:Array,productos:Array,servicios:Array},setup(h){var S,V,q,D,O,B,H;const Q=new bo({duration:5e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10B981",icon:{className:"notyf__icon--success",tagName:"i",text:"✓"}},{type:"error",background:"#EF4444",icon:{className:"notyf__icon--error",tagName:"i",text:"✗"}},{type:"info",background:"#3B82F6",icon:{className:"notyf__icon--info",tagName:"i",text:"ℹ"}}]}),r=(o,e="success")=>{Q.open({type:e,message:o})},u=h,n=so({cliente_id:((V=(S=u.cotizacion)==null?void 0:S.cliente)==null?void 0:V.id)||"",subtotal:((q=u.cotizacion)==null?void 0:q.subtotal)||0,iva:((D=u.cotizacion)==null?void 0:D.iva)||0,total:((O=u.cotizacion)==null?void 0:O.total)||0,productos:[],notas:((B=u.cotizacion)==null?void 0:B.notas)||""}),l=p([]),v=p({}),b=p({}),m=p({}),w=p(((H=u.cotizacion)==null?void 0:H.cliente)||null),_=p(!1),z=p(!0),$=p(!1),y=p([]),k=p(!1),N=p(!1),P=(o,e=0)=>{const t=parseFloat(o);return!isNaN(t)&&t>=e},F=o=>P(o,.01),U=o=>P(o,0),M=o=>{const e=parseFloat(o);return!isNaN(e)&&e>=0&&e<=100};io(()=>{var o;(o=u.cotizacion)!=null&&o.productos&&(u.cotizacion.productos.forEach(e=>{var s,c,i;const t=`${e.tipo}-${e.id}`;l.value.push({id:e.id,tipo:e.tipo}),v.value[t]=((s=e.pivot)==null?void 0:s.cantidad)||1,b.value[t]=((c=e.pivot)==null?void 0:c.precio)||0,m.value[t]=((i=e.pivot)==null?void 0:i.descuento)||0}),x())});const R=()=>{w.value&&l.value.length>0?_.value=!0:r("Selecciona un cliente y al menos un producto","error")},G=()=>{z.value=!1},A=o=>{if(!o){w.value=null,n.cliente_id="",r("Cliente eliminado","info");return}w.value=o,n.cliente_id=o.id,r(`Cliente: ${o.nombre_razon_social||o.nombre||"Sin nombre"}`)},Y=async o=>{var e,t,s,c;if(!(o!=null&&o.trim())){r("El nombre del cliente es requerido","error");return}N.value=!0;try{if(typeof route!="function")throw new Error("Route helper no está disponible");const i=await mo.post(route("clientes.store"),{nombre_razon_social:o.trim()});if(i.data){const d=i.data;u.clientes.push(d),A(d),r(`Cliente creado: ${d.nombre_razon_social||d.nombre||"Sin nombre"}`)}}catch(i){if(console.error("Error al crear cliente:",i),((e=i.response)==null?void 0:e.status)===422){const d=(t=i.response.data)==null?void 0:t.errors;if(d){const C=Object.values(d).flat().join(", ");r(`Errores de validación: ${C}`,"error")}else r("Datos de cliente inválidos","error")}else((s=i.response)==null?void 0:s.status)===409?r("Ya existe un cliente con ese nombre","error"):((c=i.response)==null?void 0:c.status)>=500?r("Error del servidor. Intenta nuevamente","error"):r("No se pudo crear el cliente","error")}finally{N.value=!1}},Z=o=>{if(!(o!=null&&o.id)||!(o!=null&&o.tipo)){r("Producto inválido","error");return}const e={id:o.id,tipo:o.tipo};if(l.value.some(s=>s.id===o.id&&s.tipo===o.tipo)){const s=o.nombre||o.descripcion||o.titulo||`${o.tipo} ${o.id}`;r(`${s} ya está agregado`,"info")}else{l.value.push(e);const s=`${o.tipo}-${o.id}`;v.value[s]=1;let c=0;o.tipo==="producto"?c=o.precio_venta||o.precio||0:o.tipo==="servicio"&&(c=o.precio||o.precio_venta||0),b.value[s]=c,m.value[s]=0,x();const i=o.nombre||o.descripcion||o.titulo||`${o.tipo} ${o.id}`;r(`Añadido: ${i}`)}},J=o=>{if(!(o!=null&&o.id)||!(o!=null&&o.tipo)){r("Error al eliminar producto","error");return}const e=`${o.tipo}-${o.id}`;l.value=l.value.filter(s=>!(s.id===o.id&&s.tipo===o.tipo)),delete v.value[e],delete b.value[e],delete m.value[e],x();const t=o.nombre||o.descripcion||o.titulo||`${o.tipo} ${o.id}`;r(`Eliminado: ${t}`,"info")},K=(o,e)=>{if(!F(e)){r("La cantidad debe ser mayor a 0","error");return}v.value[o]=parseFloat(e),x()},W=(o,e)=>{if(!M(e)){r("El descuento debe estar entre 0% y 100%","error");return}m.value[o]=parseFloat(e),x()},j=no(()=>{let o=0,e=0;l.value.forEach(i=>{const d=`${i.tipo}-${i.id}`,C=parseFloat(v.value[d])||0,to=parseFloat(b.value[d])||0,ro=parseFloat(m.value[d])||0,I=C*to,ao=I*(ro/100);o+=I,e+=ao});const t=o-e,s=t*.16,c=t+s;return{subtotal:Number(o.toFixed(2)),descuentoItems:Number(e.toFixed(2)),subtotalConDescuentos:Number(t.toFixed(2)),iva:Number(s.toFixed(2)),total:Number(c.toFixed(2))}}),x=()=>{const o=j.value;n.subtotal=o.subtotal,n.iva=o.iva,n.total=o.total},X=()=>{var o;if(!n.cliente_id){r("Selecciona un cliente","error");return}if(l.value.length===0){r("Agrega al menos un producto o servicio","error");return}for(const e of l.value){const t=`${e.tipo}-${e.id}`,s=v.value[t],c=b.value[t],i=m.value[t]||0;if(!F(s)){r(`Cantidad inválida para ${e.tipo} ${e.id}`,"error");return}if(!U(c)){r(`Precio inválido para ${e.tipo} ${e.id}`,"error");return}if(!M(i)){r(`Descuento inválido para ${e.tipo} ${e.id}`,"error");return}}if(n.productos=l.value.map(e=>{const t=`${e.tipo}-${e.id}`;return{id:e.id,tipo:e.tipo,cantidad:parseFloat(v.value[t])||1,precio:parseFloat(b.value[t])||0,descuento:parseFloat(m.value[t])||0}}),x(),typeof route!="function"){r("Error del sistema: Route helper no disponible","error");return}n.put(route("cotizaciones.update",(o=u.cotizacion)==null?void 0:o.id),{onSuccess:e=>{var t,s;if((t=e.props.flash)!=null&&t.warning&&((s=e.props.flash)!=null&&s.requiere_confirmacion_margen)){y.value=e.props.flash.productos_bajo_margen||[],$.value=!0;return}r("Cotización actualizada con éxito")},onError:e=>{if(console.error("Errores de validación:",e),typeof e=="object"&&e!==null){const t=Object.values(e).flat().join(", ");r(`Errores: ${t}`,"error")}else r("Hubo errores al actualizar la cotización","error")}})},oo=()=>{$.value=!1,y.value=[]},eo=async()=>{var o;k.value=!0;try{n.ajustar_margen=!0,n.put(route("cotizaciones.update",(o=u.cotizacion)==null?void 0:o.id),{onSuccess:()=>{$.value=!1,y.value=[],r("Cotización actualizada con precios ajustados automáticamente")},onError:e=>{console.error("Errores al ajustar precios:",e),r("Error al ajustar precios automáticamente","error")}})}catch(e){console.error("Error al ajustar precios:",e),r("Error al procesar el ajuste automático","error")}finally{k.value=!1}};return(o,e)=>(L(),T(fo,null,[f(g(lo),{title:"Editar Cotización"}),a("div",No,[a("div",jo,[N.value?(L(),T("div",Co,e[4]||(e[4]=[a("div",{class:"bg-white rounded-lg p-6 flex items-center space-x-3"},[a("div",{class:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),a("span",{class:"text-gray-700"},"Procesando...")],-1)]))):co("",!0),a("div",Eo,[f(ho,{title:"Editar Cotización",description:"Modifica los detalles de la cotización","can-preview":w.value&&l.value.length>0,"back-url":o.route&&o.route("cotizaciones.index"),"show-shortcuts":z.value,onPreview:R,onCloseShortcuts:G},null,8,["can-preview","back-url","show-shortcuts"])]),a("form",{onSubmit:uo(X,["prevent"]),class:"space-y-8 mt-6"},[a("div",Po,[e[5]||(e[5]=a("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4"},[a("h2",{class:"text-lg font-semibold text-white flex items-center"},[a("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})]),E(" Cliente ")])],-1)),a("div",Fo,[f(zo,{clientes:h.clientes,"cliente-seleccionado":w.value,onClienteSeleccionado:A,onCrearNuevoCliente:Y},null,8,["clientes","cliente-seleccionado"])])]),a("div",Mo,[e[6]||(e[6]=a("div",{class:"bg-gradient-to-r from-green-500 to-green-600 px-6 py-4"},[a("h2",{class:"text-lg font-semibold text-white flex items-center"},[a("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})]),E(" Productos y Servicios ")])],-1)),a("div",Ao,[f($o,{productos:h.productos,servicios:h.servicios,onAgregarProducto:Z},null,8,["productos","servicios"]),f(yo,{selectedProducts:l.value,productos:h.productos,servicios:h.servicios,quantities:v.value,prices:b.value,discounts:m.value,onEliminarProducto:J,onUpdateQuantity:K,onUpdateDiscount:W},null,8,["selectedProducts","productos","servicios","quantities","prices","discounts"])])]),a("div",So,[e[7]||(e[7]=a("div",{class:"bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4"},[a("h2",{class:"text-lg font-semibold text-white flex items-center"},[a("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})]),E(" Notas Adicionales ")])],-1)),a("div",Vo,[po(a("textarea",{"onUpdate:modelValue":e[0]||(e[0]=t=>g(n).notas=t),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical",rows:"4",placeholder:"Agrega notas adicionales, términos y condiciones, o información relevante para la cotización..."},null,512),[[vo,g(n).notas]])])]),f(wo,{"show-margin-calculator":!1,"margin-data":{costoTotal:0,precioVenta:0,ganancia:0,margenPorcentaje:0},totals:j.value,"item-count":l.value.length,"total-quantity":Object.values(v.value).reduce((t,s)=>t+(parseFloat(s)||0),0)},null,8,["totals","item-count","total-quantity"]),f(xo,{"back-url":o.route&&o.route("cotizaciones.index"),"is-processing":g(n).processing,"can-submit":g(n).cliente_id&&l.value.length>0,"button-text":g(n).processing?"Guardando...":"Actualizar Cotización"},null,8,["back-url","is-processing","can-submit","button-text"])],32),a("button",{onClick:e[1]||(e[1]=t=>z.value=!z.value),class:"fixed bottom-4 left-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200",title:"Mostrar/Ocultar atajos de teclado"},e[8]||(e[8]=[a("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)]))]),f(_o,{show:_.value,type:"cotizacion",cliente:w.value,items:l.value,totals:j.value,notas:g(n).notas,onClose:e[2]||(e[2]=t=>_.value=!1),onPrint:e[3]||(e[3]=()=>o.window.print())},null,8,["show","cliente","items","totals","notas"]),f(ko,{show:$.value,"productos-bajo-margen":y.value,processing:k.value,onClose:oo,onAjustarAutomaticamente:eo},null,8,["show","productos-bajo-margen","processing"])])],64))}});export{Jo as default};
