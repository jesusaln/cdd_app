import{r as f,T as ce,c as de,p as pe,O as ve,i as H,o as Q,g,f as t,u,Z as me,q as fe,l as S,v as h,z as N,x as C,s as ge,F as G,m as be,t as _e,N as ye}from"./vendor-d19pJyVS.js";import{a as he}from"./utils-Dq7h7Pqt.js";import{N as xe}from"./app-BcT2PLJy.js";import{A as we}from"./AppLayout-CcnrZQKI.js";import{_ as ke,a as Se,b as qe}from"./BotonesAccion-DYwTTkJE.js";import{_ as Fe}from"./BuscarCliente-t4xPlwkv.js";import{_ as $e,E as Ee}from"./EquiposSeleccionados-VVuQfIlX.js";import{_ as Ne}from"./VistaPreviaModal-CAwANwka.js";import{_ as Ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe={class:"ventas-edit min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6"},Ve={class:"max-w-6xl mx-auto"},Ae={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},De={class:"p-6"},Me={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},je={class:"p-6"},ze={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Be={class:"p-6"},Ie={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},Le=["value"],Te={class:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden"},Re={class:"p-6"},Ue=Object.assign({layout:we},{__name:"Edit",props:{clientes:Array,equipos:{type:Array,default:()=>[]},renta:Object},setup(q){var M,j,z,B,I,L,T;const P=new xe({duration:5e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10B981",icon:{className:"notyf__icon--success",tagName:"i",text:"✓"}},{type:"error",background:"#EF4444",icon:{className:"notyf__icon--error",tagName:"i",text:"✗"}},{type:"info",background:"#3B82F6",icon:{className:"notyf__icon--info",tagName:"i",text:"ℹ"}}]}),c=(o,e="success")=>{P.open({type:e,message:o})},n=q,F=f([...n.clientes]),a=ce({cliente_id:((M=n.renta)==null?void 0:M.cliente_id)||"",subtotal:0,descuento_items:0,iva:0,total:0,equipos:[],fecha_inicio:(j=n.renta)!=null&&j.fecha_inicio?new Date(n.renta.fecha_inicio).toISOString().split("T")[0]:"",duracion_meses:((z=n.renta)==null?void 0:z.meses_duracion)||12,deposito_garantia:((B=n.renta)==null?void 0:B.deposito_garantia)||"",dia_pago:((I=n.renta)==null?void 0:I.dia_pago)||1,forma_pago:((L=n.renta)==null?void 0:L.forma_pago)||"transferencia",observaciones:((T=n.renta)==null?void 0:T.observaciones)||""}),J=f(null),Z=f(null),l=f([]),d=f({}),v=f({}),m=f({}),p=f(null),$=f(!1),w=f(!0),x=f(!1),K=(o,e)=>{try{localStorage.setItem(o,JSON.stringify(e))}catch(r){console.warn("No se pudo guardar en localStorage:",r)}},W=o=>{try{const e=localStorage.getItem(o);return e?JSON.parse(e):null}catch(e){return console.warn("No se pudo cargar desde localStorage:",e),null}},V=o=>{try{localStorage.removeItem(o)}catch(e){console.warn("No se pudo eliminar de localStorage:",e)}},X=()=>{p.value&&l.value.length>0?$.value=!0:c("Selecciona un cliente y al menos un equipo","error")},Y=()=>{w.value=!1},A=o=>{var e;if(!o){p.value=null,a.cliente_id="",y(),c("Selección de cliente limpiada","info");return}((e=p.value)==null?void 0:e.id)!==o.id&&(p.value=o,a.cliente_id=o.id,y(),c(`Cliente seleccionado: ${o.nombre_razon_social}`))},ee=async o=>{try{const r=(await he.post(route("clientes.store"),{nombre_razon_social:o})).data;F.value.some(i=>i.id===r.id)||F.value.push(r),A(r),c(`Cliente creado: ${r.nombre_razon_social}`)}catch(e){console.error("Error al crear cliente:",e),c("No se pudo crear el cliente","error")}},oe=o=>{if(!o||typeof o.id>"u"){c("Equipo inválido","error");return}const e={id:o.id,tipo:"equipo"};if(!l.value.some(i=>i.id===o.id&&i.tipo==="equipo")){l.value.push(e);const i=`equipo-${o.id}`;d.value[i]=1;let s=typeof o.precio_renta_mensual=="number"?o.precio_renta_mensual:0;v.value[i]=s,m.value[i]=0,b(),y(),c(`Equipo añadido: ${o.nombre||o.descripcion||"Equipo"}`)}},ae=o=>{if(!o||typeof o.id>"u"||!o.tipo)return;const e=`${o.tipo}-${o.id}`;l.value=l.value.filter(r=>!(r.id===o.id&&r.tipo===r.tipo)),delete d.value[e],delete v.value[e],delete m.value[e],b(),y(),c(`Equipo eliminado: ${o.nombre||o.descripcion||"Equipo"}`,"info")},te=()=>{var o;p.value=null,a.cliente_id="",l.value=[],d.value={},v.value={},m.value={},a.fecha_inicio=new Date().toISOString().split("T")[0],a.duracion_meses=12,a.deposito_garantia="",a.dia_pago=1,a.forma_pago="transferencia",a.observaciones="",localStorage.removeItem(`renta_edit_${(o=n.renta)==null?void 0:o.id}`),P.success("Formulario limpiado correctamente")},re=(o,e)=>{const r=parseFloat(e);isNaN(r)||r<0||(d.value[o]=r,b(),y())},se=(o,e)=>{const r=parseFloat(e);isNaN(r)||r<0||r>100||(m.value[o]=r,b(),y())},_=de(()=>{let o=0,e=0;l.value.forEach(k=>{const E=`${k.tipo}-${k.id}`,R=parseFloat(d.value[E])||0,U=parseFloat(v.value[E])||0,ue=parseFloat(m.value[E])||0;if(R>0&&U>=0){const O=R*U;e+=O*(ue/100),o+=O}});const r=Math.max(0,o-e),i=r*.16,s=r+i;return{subtotal:parseFloat(o.toFixed(2)),descuentoItems:parseFloat(e.toFixed(2)),subtotalConDescuentos:parseFloat(r.toFixed(2)),iva:parseFloat(i.toFixed(2)),total:parseFloat(s.toFixed(2))}}),b=()=>{a.subtotal=_.value.subtotal,a.descuento_items=_.value.descuentoItems,a.iva=_.value.iva,a.total=_.value.total},ne=()=>{if(!a.cliente_id)return c("Selecciona un cliente","error"),!1;if(l.value.length===0)return c("Agrega al menos un equipo","error"),!1;if(!a.fecha_inicio)return c("Selecciona una fecha de inicio","error"),!1;for(const o of l.value){const e=`${o.tipo}-${o.id}`,r=parseFloat(m.value[e])||0,i=parseFloat(d.value[e])||0,s=parseFloat(v.value[e])||0;if(r<0||r>100)return c("Los descuentos deben estar entre 0% y 100%.","error"),!1;if(i<=0)return c("Las cantidades deben ser mayores a 0","error"),!1;if(s<0)return c("Los precios no pueden ser negativos","error"),!1}return!0},ie=()=>{if(!ne())return;a.equipos=l.value.map(e=>{const r=`${e.tipo}-${e.id}`;return{equipo_id:e.id,precio_mensual:parseFloat(v.value[r])||0}}),b();const o={cliente_id:a.cliente_id,equipos:a.equipos,fecha_inicio:a.fecha_inicio,duracion_meses:a.duracion_meses,precio_mensual:a.subtotal,deposito_garantia:a.deposito_garantia||0,dia_pago:a.dia_pago,forma_pago:a.forma_pago,observaciones:a.observaciones,tiene_prorroga:!1};x.value=!0,ye.put(route("rentas.update",n.renta.id),o,{onSuccess:()=>{V(`renta_edit_${n.renta.id}`),x.value=!1,c("Renta actualizada con éxito")},onError:e=>{console.error("Errores de validación:",e);const r=Object.values(e)[0];Array.isArray(r)?c(r[0],"error"):c("Hubo errores de validación","error"),x.value=!1}})},le=()=>{n.renta&&(n.renta.cliente&&(p.value=n.renta.cliente,a.cliente_id=n.renta.cliente.id),n.renta.equipos&&Array.isArray(n.renta.equipos)&&n.renta.equipos.forEach(o=>{var i;const e={id:o.id,tipo:"equipo"};l.value.push(e);const r=`equipo-${o.id}`;d.value[r]=1,v.value[r]=((i=o.pivot)==null?void 0:i.precio_mensual)||o.precio_renta_mensual||0,m.value[r]=0}),b())},D=o=>{(a.cliente_id||l.value.length>0)&&(o.preventDefault(),o.returnValue="Tienes cambios sin guardar. ¿Estás seguro de que quieres salir?")},y=()=>{var e;const o={cliente_id:a.cliente_id,cliente:p.value,selectedProducts:l.value,quantities:d.value,prices:v.value,discounts:m.value,fecha_inicio:a.fecha_inicio,duracion_meses:a.duracion_meses,deposito_garantia:a.deposito_garantia,dia_pago:a.dia_pago,forma_pago:a.forma_pago,observaciones:a.observaciones};K(`renta_edit_${(e=n.renta)==null?void 0:e.id}`,o)};return pe(()=>{var e,r;le();const o=W(`renta_edit_${(e=n.renta)==null?void 0:e.id}`);if(o&&typeof o=="object")try{a.cliente_id=o.cliente_id||a.cliente_id,p.value=o.cliente||p.value,l.value=Array.isArray(o.selectedProducts)?o.selectedProducts:l.value,d.value=o.quantities||d.value,v.value=o.prices||v.value,m.value=o.discounts||m.value,a.fecha_inicio=o.fecha_inicio||a.fecha_inicio,a.duracion_meses=o.duracion_meses||a.duracion_meses,a.deposito_garantia=o.deposito_garantia||a.deposito_garantia,a.dia_pago=o.dia_pago||a.dia_pago,a.forma_pago=o.forma_pago||a.forma_pago,a.observaciones=o.observaciones||a.observaciones,b()}catch(i){console.warn("Error al cargar datos guardados:",i),V(`renta_edit_${(r=n.renta)==null?void 0:r.id}`)}window.addEventListener("beforeunload",D)}),ve(()=>{window.removeEventListener("beforeunload",D)}),(o,e)=>{var r,i;return Q(),H(G,null,[g(u(me),{title:`Editar Renta ${((r=q.renta)==null?void 0:r.numero_contrato)||""}`},null,8,["title"]),t("div",Pe,[t("div",Ve,[g(ke,{title:`Editar Renta ${((i=q.renta)==null?void 0:i.numero_contrato)||""}`,description:"Modifica los equipos, fechas de cobro y otros detalles de la renta","can-preview":p.value&&l.value.length>0,"back-url":o.route("rentas.index"),"show-shortcuts":w.value,onPreview:X,onCloseShortcuts:Y},null,8,["title","can-preview","back-url","show-shortcuts"]),t("form",{onSubmit:fe(ie,["prevent"]),class:"space-y-8"},[t("div",Ae,[e[10]||(e[10]=t("div",{class:"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})]),S(" Información del Cliente ")])],-1)),t("div",De,[g(Fe,{ref_key:"buscarClienteRef",ref:J,clientes:F.value,"cliente-seleccionado":p.value,onClienteSeleccionado:A,onCrearNuevoCliente:ee},null,8,["clientes","cliente-seleccionado"])])]),t("div",Me,[e[11]||(e[11]=t("div",{class:"bg-gradient-to-r from-green-500 to-green-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})]),S(" Equipos Rentados ")])],-1)),t("div",je,[g($e,{ref_key:"buscarProductoRef",ref:Z,equipos:n.equipos,onAgregarProducto:oe},null,8,["equipos"]),g(Ee,{selectedProducts:l.value,equipos:n.equipos,quantities:d.value,prices:v.value,discounts:m.value,onEliminarProducto:ae,onUpdateQuantity:re,onUpdateDiscount:se},null,8,["selectedProducts","equipos","quantities","prices","discounts"])])]),t("div",ze,[e[19]||(e[19]=t("div",{class:"bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})]),S(" Configuración del Contrato ")])],-1)),t("div",Be,[t("div",Ie,[t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Fecha de Inicio",-1)),h(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>u(a).fecha_inicio=s),type:"date",class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"},null,512),[[N,u(a).fecha_inicio]])]),t("div",null,[e[14]||(e[14]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Duración (meses)",-1)),h(t("select",{"onUpdate:modelValue":e[1]||(e[1]=s=>u(a).duracion_meses=s),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"},e[13]||(e[13]=[ge('<option value="6" data-v-2e49ce97>6 meses</option><option value="12" data-v-2e49ce97>12 meses</option><option value="18" data-v-2e49ce97>18 meses</option><option value="24" data-v-2e49ce97>24 meses</option><option value="36" data-v-2e49ce97>36 meses</option>',5)]),512),[[C,u(a).duracion_meses]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Día de Pago",-1)),h(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>u(a).dia_pago=s),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"},[(Q(),H(G,null,be(28,s=>t("option",{key:s,value:s},"Día "+_e(s),9,Le)),64))],512),[[C,u(a).dia_pago]])]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Forma de Pago",-1)),h(t("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>u(a).forma_pago=s),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"},e[16]||(e[16]=[t("option",{value:"transferencia"},"Transferencia Bancaria",-1),t("option",{value:"efectivo"},"Efectivo",-1),t("option",{value:"tarjeta"},"Tarjeta de Crédito",-1),t("option",{value:"cheque"},"Cheque",-1)]),512),[[C,u(a).forma_pago]])]),t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Depósito de Garantía",-1)),h(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>u(a).deposito_garantia=s),type:"number",step:"0.01",placeholder:"0.00",class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"},null,512),[[N,u(a).deposito_garantia]])])])])]),t("div",Te,[e[20]||(e[20]=t("div",{class:"bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4"},[t("h2",{class:"text-lg font-semibold text-white flex items-center"},[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})]),S(" Notas Adicionales ")])],-1)),t("div",Re,[h(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>u(a).observaciones=s),class:"w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical",rows:"4",placeholder:"Agrega notas adicionales, términos y condiciones, o información relevante para la renta..."},null,512),[[N,u(a).observaciones]])])]),g(Se,{"show-margin-calculator":!1,"margin-data":{costoTotal:0,precioVenta:0,ganancia:0,margenPorcentaje:0},totals:_.value,"item-count":l.value.length,"total-quantity":Object.values(d.value).reduce((s,k)=>s+(k||0),0),"deposito-garantia":u(a).deposito_garantia,"onUpdate:descuentoGeneral":e[6]||(e[6]=s=>u(a).descuento_general=s)},null,8,["totals","item-count","total-quantity","deposito-garantia"]),g(qe,{"back-url":o.route("rentas.index"),"is-processing":x.value,"can-submit":u(a).cliente_id&&l.value.length>0,"button-text":x.value?"Actualizando...":"Actualizar Renta",onLimpiar:te},null,8,["back-url","is-processing","can-submit","button-text"])],32),t("button",{onClick:e[7]||(e[7]=s=>w.value=!w.value),class:"fixed bottom-4 left-4 bg-gray-600 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-200",title:"Mostrar atajos de teclado"},e[21]||(e[21]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)]))])]),g(Ne,{show:$.value,type:"renta",cliente:p.value,items:l.value,totals:_.value,notas:u(a).observaciones,"deposito-garantia":u(a).deposito_garantia,onClose:e[8]||(e[8]=s=>$.value=!1),onPrint:e[9]||(e[9]=()=>o.window.print())},null,8,["show","cliente","items","totals","notas","deposito-garantia"])],64)}}}),Ye=Ce(Ue,[["__scopeId","data-v-2e49ce97"]]);export{Ye as default};
