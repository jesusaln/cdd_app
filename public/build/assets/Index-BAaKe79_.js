import{c as I,R as me,i as g,o as p,f as r,t as M,k as C,n as S,F as G,m as ve,l as Q,g as B,r as F,w as q,u as ge,Z as pe,N as ee}from"./vendor-d19pJyVS.js";import{a as te}from"./utils-Dq7h7Pqt.js";import{N as fe}from"./app-BcT2PLJy.js";import{g as he}from"./pdfGenerator-C15gTT3V.js";import{A as ye}from"./AppLayout-CcnrZQKI.js";import{P as be}from"./PedidosHeader-BSl_NYVt.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{M as xe}from"./Modales-BBthfVFz.js";import{_ as we}from"./Pagination-B0Pz79Or.js";import"./jspdf.es.min-BE3S9W4e.js";const _e={class:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"},ke={class:"bg-gradient-to-r from-gray-50 to-gray-100/50 px-6 py-4 border-b border-gray-200/60"},Ee={class:"flex items-center justify-between"},Ce={class:"text-sm text-gray-600 bg-white/70 px-3 py-1 rounded-full border border-gray-200/50"},Pe={class:"overflow-x-auto"},$e={class:"min-w-full divide-y divide-gray-200/60"},Fe={class:"bg-gray-50/60"},Be={class:"flex items-center space-x-1"},Le={class:"flex items-center space-x-1"},Ne={class:"flex items-center space-x-1"},De={class:"flex items-center space-x-1"},Ie={class:"flex items-center space-x-1"},Ve={class:"bg-white divide-y divide-gray-200/40"},Ae={class:"px-6 py-4"},Me={class:"flex flex-col space-y-0.5"},Se={class:"text-sm font-medium text-gray-900"},je={class:"text-xs text-gray-500"},Te={class:"px-6 py-4"},ze={class:"flex flex-col space-y-0.5"},Oe={class:"text-sm font-medium text-gray-900 group-hover:text-gray-800"},Re={key:0,class:"text-xs text-gray-500 truncate max-w-48"},We={class:"px-6 py-4"},Ue={class:"text-sm font-mono font-medium text-gray-700 bg-gray-100/60 px-2 py-1 rounded-md inline-block"},He={class:"px-6 py-4"},Ke={class:"text-sm font-semibold text-gray-900"},Xe={class:"px-6 py-4"},qe={class:"px-6 py-4"},Ge={class:"flex items-center justify-end space-x-1"},Ye=["onClick"],Ze=["onClick"],Je=["onClick"],Qe=["onClick","title"],et=["onClick"],tt=["onClick"],ot={key:1},rt={__name:"PedidosTable",props:{documentos:{type:Array,default:()=>[]},searchTerm:{type:String,default:""},sortBy:{type:String,default:"fecha-desc"}},emits:["ver-detalles","editar","eliminar","imprimir","sort","enviar-venta","enviar-email"],setup(x,{emit:H}){const d=x,w=H,E={borrador:{label:"Borrador",classes:"bg-gray-100 text-gray-700",color:"bg-gray-400"},pendiente:{label:"Pendiente",classes:"bg-yellow-100 text-yellow-700",color:"bg-yellow-400"},confirmado:{label:"Confirmado",classes:"bg-blue-100 text-blue-700",color:"bg-blue-400"},en_preparacion:{label:"En Preparación",classes:"bg-orange-100 text-orange-700",color:"bg-orange-400"},listo_entrega:{label:"Listo para Entrega",classes:"bg-purple-100 text-purple-700",color:"bg-purple-400"},entregado:{label:"Entregado",classes:"bg-green-100 text-green-700",color:"bg-green-400"},enviado_venta:{label:"Enviado a Venta",classes:"bg-indigo-100 text-indigo-700",color:"bg-indigo-400"},cancelado:{label:"Cancelado",classes:"bg-red-100 text-red-700",color:"bg-red-400"}},z=n=>{var t;return((t=E[n])==null?void 0:t.classes)||"bg-gray-100 text-gray-700"},j=n=>{var t;return((t=E[n])==null?void 0:t.color)||"bg-gray-400"},P=n=>{var t;return((t=E[n])==null?void 0:t.label)||"Pendiente"},Y=n=>n?["confirmado","en_preparacion","listo entrega","entregado","borrador"].includes(n.estado):!1,b=new Map,L=n=>{if(!n)return"Fecha no disponible";const t=`fecha-${n}`;if(b.has(t))return b.get(t);try{const c=new Date(n).getTime();if(Number.isNaN(c))return"Fecha inválida";const o=new Date(c).toLocaleDateString("es-MX",{day:"2-digit",month:"2-digit",year:"numeric"});return b.set(t,o),o}catch{return"Fecha inválida"}},N=n=>{if(!n)return"";const t=`hora-${n}`;if(b.has(t))return b.get(t);try{const c=new Date(n).getTime();if(Number.isNaN(c))return"";const o=new Date(c).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"});return b.set(t,o),o}catch{return""}},V=n=>{const t=parseFloat(n),c=Number.isFinite(t)?t:0,o=`moneda-${c}`;if(b.has(o))return b.get(o);const m=new Intl.NumberFormat("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}).format(c);return b.set(o,m),m},f=I(()=>{if(!Array.isArray(d.documentos))return[];let n=d.documentos.slice();if(d.searchTerm){const o=d.searchTerm.toLowerCase();n=n.filter(m=>{var y;return(((y=m.cliente)==null?void 0:y.nombre)||"").toLowerCase().includes(o)||(m.numero_pedido||m.id||"").toString().toLowerCase().includes(o)||(m.estado||"").toLowerCase().includes(o)})}const[t,c]=d.sortBy.split("-");return n.sort((o,m)=>{var K,U;let y,_;switch(t){case"fecha":y=new Date(o.created_at||o.fecha||0).getTime(),_=new Date(m.created_at||m.fecha||0).getTime();break;case"cliente":y=(((K=o.cliente)==null?void 0:K.nombre)||"").toLowerCase(),_=(((U=m.cliente)==null?void 0:U.nombre)||"").toLowerCase();break;case"numero_pedido":y=(o.numero_pedido||o.id||"").toString().toLowerCase(),_=(m.numero_pedido||m.id||"").toString().toLowerCase();break;case"total":y=parseFloat(o.total||0),_=parseFloat(m.total||0);break;case"estado":y=(o.estado||"").toLowerCase(),_=(m.estado||"").toLowerCase();break;default:y=(o[t]||"").toLowerCase(),_=(m[t]||"").toLowerCase()}const D=y<_?-1:y>_?1:0;return c==="desc"?-D:D})}),Z=I(()=>{var n;return((n=d.documentos)==null?void 0:n.length)||0}),h=n=>w("ver-detalles",n),$=n=>w("editar",n),O=n=>w("eliminar",n),J=n=>w("imprimir",n),R=n=>w("enviar-venta",n),W=n=>w("enviar-email",n),T=n=>{const c=(d.sortBy.startsWith(n)?d.sortBy:`${n}-desc`)===`${n}-desc`?`${n}-asc`:`${n}-desc`;w("sort",c)};return(n,t)=>{const c=me("font-awesome-icon");return p(),g("div",_e,[r("div",ke,[r("div",Ee,[t[5]||(t[5]=r("h2",{class:"text-lg font-semibold text-gray-900 tracking-tight"},"Pedidos",-1)),r("div",Ce,M(f.value.length)+" de "+M(Z.value)+" pedidos ",1)])]),r("div",Pe,[r("table",$e,[r("thead",Fe,[r("tr",null,[r("th",{class:"group px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100/60 transition-colors duration-150",onClick:t[0]||(t[0]=o=>T("fecha"))},[r("div",Be,[t[7]||(t[7]=r("span",null,"Fecha",-1)),x.sortBy.startsWith("fecha")?(p(),g("svg",{key:0,class:S(["w-4 h-4 transition-transform duration-200",x.sortBy==="fecha-desc"?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t[6]||(t[6]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2)):C("",!0)])]),r("th",{class:"group px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100/60 transition-colors duration-150",onClick:t[1]||(t[1]=o=>T("cliente"))},[r("div",Le,[t[9]||(t[9]=r("span",null,"Cliente",-1)),x.sortBy.startsWith("cliente")?(p(),g("svg",{key:0,class:S(["w-4 h-4 transition-transform duration-200",x.sortBy==="cliente-desc"?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t[8]||(t[8]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2)):C("",!0)])]),r("th",{class:"group px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100/60 transition-colors duration-150",onClick:t[2]||(t[2]=o=>T("numero_pedido"))},[r("div",Ne,[t[11]||(t[11]=r("span",null,"N° Pedido",-1)),x.sortBy.startsWith("numero_pedido")?(p(),g("svg",{key:0,class:S(["w-4 h-4 transition-transform duration-200",x.sortBy==="numero_pedido-desc"?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t[10]||(t[10]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2)):C("",!0)])]),r("th",{class:"group px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100/60 transition-colors duration-150",onClick:t[3]||(t[3]=o=>T("total"))},[r("div",De,[t[13]||(t[13]=r("span",null,"Total",-1)),x.sortBy.startsWith("total")?(p(),g("svg",{key:0,class:S(["w-4 h-4 transition-transform duration-200",x.sortBy==="total-desc"?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t[12]||(t[12]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2)):C("",!0)])]),r("th",{class:"group px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100/60 transition-colors duration-150",onClick:t[4]||(t[4]=o=>T("estado"))},[r("div",Ie,[t[15]||(t[15]=r("span",null,"Estado",-1)),x.sortBy.startsWith("estado")?(p(),g("svg",{key:0,class:S(["w-4 h-4 transition-transform duration-200",x.sortBy==="estado-desc"?"rotate-180":""]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t[14]||(t[14]=[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2)):C("",!0)])]),t[16]||(t[16]=r("th",{class:"px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider"}," Acciones ",-1))])]),r("tbody",Ve,[f.value.length>0?(p(!0),g(G,{key:0},ve(f.value,o=>{var m,y,_;return p(),g("tr",{key:o.id,class:S(["group hover:bg-gray-50/60 transition-all duration-150 hover:shadow-sm",o.estado==="cancelado"?"opacity-50":""])},[r("td",Ae,[r("div",Me,[r("div",Se,M(L(o.created_at||o.fecha)),1),r("div",je,M(N(o.created_at||o.fecha)),1)])]),r("td",Te,[r("div",ze,[r("div",Oe,M(((m=o.cliente)==null?void 0:m.nombre)||"Sin cliente"),1),(y=o.cliente)!=null&&y.email?(p(),g("div",Re,M(o.cliente.email),1)):C("",!0)])]),r("td",We,[r("div",Ue,M(o.numero_pedido||o.id||"N/A"),1)]),r("td",He,[r("div",Ke,[typeof o.total<"u"&&o.total!==null?(p(),g(G,{key:0},[Q(" $"+M(V(o.total)),1)],64)):(p(),g(G,{key:1},[Q("-")],64))])]),r("td",Xe,[r("span",{class:S([z(o.estado),"inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-150 hover:shadow-sm"])},[r("span",{class:S(["w-2 h-2 rounded-full mr-2 transition-all duration-150",j(o.estado)])},null,2),Q(" "+M(P(o.estado)),1)],2)]),r("td",qe,[r("div",Ge,[r("button",{onClick:D=>h(o),class:"group/btn relative inline-flex items-center justify-center w-9 h-9 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:ring-offset-1",title:"Ver detalles"},[B(c,{icon:"eye",class:"w-4 h-4 transition-transform duration-200 group-hover/btn:scale-110"})],8,Ye),o.estado!=="cancelado"?(p(),g("button",{key:0,onClick:D=>$(o.id),class:"group/btn relative inline-flex items-center justify-center w-9 h-9 rounded-lg bg-amber-50 text-amber-600 hover:bg-amber-100 hover:text-amber-700 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:ring-offset-1",title:"Editar"},[B(c,{icon:"edit",class:"w-4 h-4 transition-transform duration-200 group-hover/btn:scale-110"})],8,Ze)):C("",!0),Y(o)&&o.estado!=="cancelado"?(p(),g("button",{key:1,onClick:D=>R(o),class:"group/btn relative inline-flex items-center justify-center w-9 h-9 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:ring-offset-1",title:"Enviar a Venta"},[B(c,{icon:"paper-plane",class:"w-4 h-4 transition-transform duration-200 group-hover/btn:scale-110"})],8,Je)):C("",!0),o.estado!=="cancelado"&&((_=o.cliente)!=null&&_.email)?(p(),g("button",{key:2,onClick:D=>W(o),class:"group/btn relative inline-flex items-center justify-center w-9 h-9 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:ring-offset-1",title:o.email_enviado?"Reenviar por Email":"Enviar por Email"},[B(c,{icon:o.email_enviado?"envelope-open":"envelope",class:"w-4 h-4 transition-transform duration-200 group-hover/btn:scale-110"},null,8,["icon"])],8,Qe)):C("",!0),o.estado!=="cancelado"?(p(),g("button",{key:3,onClick:D=>J(o),class:"group/btn relative inline-flex items-center justify-center w-9 h-9 rounded-lg bg-purple-50 text-purple-600 hover:bg-purple-100 hover:text-purple-700 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:ring-offset-1",title:"Imprimir"},[B(c,{icon:"print",class:"w-4 h-4 transition-transform duration-200 group-hover/btn:scale-110"})],8,et)):C("",!0),o.estado!=="cancelado"&&o.estado!=="cancelada"?(p(),g("button",{key:4,onClick:D=>O(o.id),class:"group/btn relative inline-flex items-center justify-center w-9 h-9 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 hover:shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500/50 focus:ring-offset-1",title:"Eliminar"},[B(c,{icon:"trash",class:"w-4 h-4 transition-transform duration-200 group-hover/btn:scale-110"})],8,tt)):C("",!0)])])],2)}),128)):(p(),g("tr",ot,t[17]||(t[17]=[r("td",{colspan:6,class:"px-6 py-16 text-center"},[r("div",{class:"flex flex-col items-center space-y-4"},[r("div",{class:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center"},[r("svg",{class:"w-8 h-8 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1.5",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})])]),r("div",{class:"space-y-1"},[r("p",{class:"text-gray-700 font-medium"},"No hay pedidos"),r("p",{class:"text-sm text-gray-500"},"Los pedidos aparecerán aquí cuando se creen")])])],-1)])))])])])])}}},at=re(rt,[["__scopeId","data-v-4d138789"]]),nt={class:"pedidos-index min-h-screen bg-gray-50"},st={class:"max-w-8xl mx-auto px-6 py-8"},it={class:"mt-6"},lt={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},dt=Object.assign({layout:ye},{__name:"Index",props:{pedidos:{type:Array,default:()=>[]}},setup(x){const H=x,d=new fe({duration:4e3,position:{x:"right",y:"top"},types:[{type:"success",background:"#10b981",icon:!1},{type:"error",background:"#ef4444",icon:!1},{type:"warning",background:"#f59e0b",icon:!1}]}),w=F(!1),E=F(null),z=F("details"),j=F(null),P=F(!1),Y=e=>{E.value=e||null,z.value="details",w.value=!0},b=()=>{w.value=!1,E.value=null,j.value=null},L=F(""),N=F("fecha-desc"),V=F(""),f=F([...H.pedidos]),Z=I(()=>{const e=E.value;if(!e)return null;const a=e.metadata||{};return{creado_por:e.creado_por_nombre||e.created_by_user_name||a.creado_por||"N/A",actualizado_por:e.actualizado_por_nombre||e.updated_by_user_name||a.actualizado_por||"N/A",eliminado_por:e.eliminado_por_nombre||e.deleted_by_user_name||a.eliminado_por||null,creado_en:e.created_at||a.creado_en||null,actualizado_en:e.updated_at||a.actualizado_en||null,eliminado_en:e.deleted_at||a.eliminado_en||null}});I(()=>[...f.value]);const h=F(1),$=F(10),O=I(()=>{let e=[...f.value];if(L.value.trim()){const a=L.value.toLowerCase().trim();e=e.filter(l=>{var u,v,A;const k=((v=(u=l.cliente)==null?void 0:u.nombre)==null?void 0:v.toLowerCase())||"",i=String(l.numero_pedido||l.id||"").toLowerCase(),s=((A=l.estado)==null?void 0:A.toLowerCase())||"";return k.includes(a)||i.includes(a)||s.includes(a)})}if(V.value&&(e=e.filter(a=>a.estado===V.value)),N.value){const[a,l]=N.value.split("-"),k=l==="desc";e.sort((i,s)=>{var A,X;let u,v;switch(a){case"fecha":u=new Date(i.fecha||i.created_at||0),v=new Date(s.fecha||s.created_at||0);break;case"cliente":u=((A=i.cliente)==null?void 0:A.nombre)||"",v=((X=s.cliente)==null?void 0:X.nombre)||"";break;case"total":u=parseFloat(i.total||0),v=parseFloat(s.total||0);break;case"estado":u=i.estado||"",v=s.estado||"";break;default:u=i[a]||"",v=s[a]||""}return u<v?k?1:-1:u>v?k?-1:1:0})}return e}),J=I(()=>{const e=(h.value-1)*$.value,a=e+$.value;return O.value.slice(e,a)}),R=I(()=>Math.ceil(O.value.length/$.value)),W=I(()=>O.value.length),T=I(()=>({current_page:h.value,last_page:R.value,per_page:$.value,from:W.value>0?(h.value-1)*$.value+1:0,to:Math.min(h.value*$.value,W.value),total:W.value,prev_page_url:h.value>1?"#":null,next_page_url:h.value<R.value?"#":null,links:[]}));q([L,N,V,$],()=>{h.value=1},{deep:!0});const n=e=>{$.value=e,h.value=1},t=e=>{h.value=e};q(()=>H.pedidos,e=>{Array.isArray(e)&&(f.value=[...e])},{deep:!0,immediate:!0}),q([L,V],()=>{h.value=1}),q(R,e=>{h.value>e&&e>0&&(h.value=e)});const c=I(()=>{const e={total:f.value.length,pendientes:0,borrador:0,enviado_venta:0,cancelado:0};return f.value.forEach(a=>{switch(String(a.estado||"").toLowerCase()){case"pendiente":e.pendientes++;break;case"borrador":e.borrador++;break;case"enviado_venta":e.enviado_venta++;break;case"enviado":e.pendientes++;break;case"cancelado":e.cancelado++;break;default:e.pendientes++;break}}),e}),o=()=>{L.value="",N.value="fecha-desc",V.value="",$.value=10,h.value=1,d.success("Filtros limpiados correctamente")},m=e=>{e&&typeof e=="string"&&(N.value=e,h.value=1)};function y(e){return e?["confirmado","en_preparacion","listo_entrega","entregado","borrador"].includes(e.estado):!1}function _(e){if(!(e!=null&&e.id))throw new Error("ID de pedido no válido");return!0}function D(e){var a;if(!e.id)throw new Error("ID del documento no encontrado");if(!((a=e.cliente)!=null&&a.nombre))throw new Error("Datos del cliente no encontrados");if(!Array.isArray(e.productos)||!e.productos.length)throw new Error("Lista de productos no válida");if(!e.fecha)throw new Error("Fecha no especificada");return!0}const K=e=>{try{_(e),Y(e)}catch(a){d.error(a.message)}},U=e=>{var a;try{const l=e||((a=E.value)==null?void 0:a.id);if(!l)throw new Error("ID de pedido no válido");ee.visit(`/pedidos/${l}/edit`)}catch(l){d.error(l.message)}},ae=e=>{U(e)},ne=async e=>{try{const a={...e,fecha:e.fecha||e.created_at||new Date().toISOString()};D(a),P.value=!0,d.success("Generando PDF..."),await he("Pedido",a),d.success("PDF generado correctamente")}catch(a){console.error("Error al generar PDF:",a),d.error(`Error al generar el PDF: ${a.message}`)}finally{P.value=!1}},se=e=>{try{if(!e)throw new Error("ID de pedido no válido");j.value=e,z.value="confirm",w.value=!0}catch(a){d.error(a.message)}},ie=async()=>{var e,a,l,k;try{if(!j.value)throw new Error("No se seleccionó ningún pedido para cancelar");P.value=!0,d.success("Cancelando pedido...");const{data:i}=await te.post(`/pedidos/${j.value}/cancel`);if(i!=null&&i.success){d.success(i.message||"Pedido cancelado exitosamente");const s=f.value.findIndex(u=>u.id===j.value);s!==-1&&(f.value[s]={...f.value[s],estado:"cancelado",eliminado_por:(i==null?void 0:i.eliminado_por)||"Usuario actual",deleted_at:new Date().toISOString()}),b()}else throw new Error((i==null?void 0:i.error)||"Error al cancelar el pedido")}catch(i){console.error("Error al cancelar:",i);let s="Error al cancelar el pedido";(a=(e=i.response)==null?void 0:e.data)!=null&&a.error?s=i.response.data.error:(k=(l=i.response)==null?void 0:l.data)!=null&&k.message?s=i.response.data.message:i.message&&(s=i.message),d.error(s)}finally{P.value=!1}},oe=async e=>{var a,l,k,i;try{const s=e!=null&&e.id?e:E.value;if(!y(s))throw new Error("El pedido no está en un estado válido para enviar a venta");const u={...s,fecha:s.fecha||s.created_at||new Date().toISOString()};P.value=!0,d.success("Enviando pedido a venta...");const{data:v}=await te.post(`/pedidos/${u.id}/enviar-a-venta`,{forzarReenvio:!!(e!=null&&e.forzarReenvio)});if(v!=null&&v.success){d.success(v.message||"Pedido enviado a venta exitosamente");const A=f.value.findIndex(X=>X.id===u.id);A!==-1&&(f.value[A]={...f.value[A],estado:"enviado_venta"}),b(),ee.visit("/ventas")}else throw new Error((v==null?void 0:v.error)||"No se pudo enviar a venta")}catch(s){console.error("Error al enviar a venta:",s);let u="Error desconocido al enviar a venta";(l=(a=s.response)==null?void 0:a.data)!=null&&l.error?u=s.response.data.error:(i=(k=s.response)==null?void 0:k.data)!=null&&i.message?u=s.response.data.message:s.message&&(u=s.message),d.error(u)}finally{P.value=!1}},le=()=>{d.warning("Esta acción no está disponible desde Pedidos.")},de=async e=>{var a;try{if(!((a=e.cliente)!=null&&a.email)){d.error("El cliente no tiene email configurado");return}console.log("=== ENVIANDO PEDIDO POR EMAIL ==="),console.log("Pedido ID:",e.id),console.log("Cliente email:",e.cliente.email),E.value={...e,numero_pedido:e.numero_pedido||`P${String(e.id).padStart(3,"0")}`,email_destino:e.cliente.email},z.value="confirm-email",w.value=!0}catch(l){console.error("Error en enviarPedidoPorEmail:",l),d.error("Error inesperado al preparar envío de pedido")}},ce=async()=>{var e,a,l,k;try{const i=E.value;if(!(i!=null&&i.email_destino)){d.error("Email de destino no válido");return}console.log("✅ Usuario confirmó envío de pedido por email"),P.value=!0,b();const{data:s}=await te.post(`/pedidos/${i.id}/enviar-email`,{email_destino:i.email_destino});if(s!=null&&s.success){d.success(s.message||"Pedido enviado por email correctamente");const u=f.value.findIndex(v=>v.id===i.id);u!==-1&&s.pedido&&(f.value[u]={...f.value[u],email_enviado:s.pedido.email_enviado,email_enviado_fecha:s.pedido.email_enviado_fecha,estado:s.pedido.estado})}else throw new Error((s==null?void 0:s.error)||"Error desconocido al enviar email")}catch(i){console.error("Error al enviar pedido:",i);const s=((a=(e=i.response)==null?void 0:e.data)==null?void 0:a.error)||((k=(l=i.response)==null?void 0:l.data)==null?void 0:k.message)||i.message;d.error("Error al enviar pedido: "+s)}finally{P.value=!1}},ue=()=>{ee.visit("/pedidos/create")};return(e,a)=>(p(),g(G,null,[B(ge(pe),{title:"Pedidos"}),r("div",nt,[r("div",st,[B(be,{total:c.value.total,pendientes:c.value.pendientes,borrador:c.value.borrador,enviado_venta:c.value.enviado_venta,cancelado:c.value.cancelado,"search-term":L.value,"onUpdate:searchTerm":a[0]||(a[0]=l=>L.value=l),"sort-by":N.value,"onUpdate:sortBy":a[1]||(a[1]=l=>N.value=l),"filtro-estado":V.value,"onUpdate:filtroEstado":a[2]||(a[2]=l=>V.value=l),config:{module:"pedidos",createButtonText:"Nuevo Pedido",searchPlaceholder:"Buscar por cliente, número..."},onLimpiarFiltros:o,onCrearNuevo:ue},null,8,["total","pendientes","borrador","enviado_venta","cancelado","search-term","sort-by","filtro-estado"]),r("div",it,[B(at,{documentos:J.value,"search-term":L.value,"sort-by":N.value,onVerDetalles:K,onEditar:U,onEliminar:se,onEnviarVenta:oe,onEnviarEmail:de,onImprimir:ne,onSort:m},null,8,["documentos","search-term","sort-by"]),B(we,{"pagination-data":T.value,onPerPageChange:n,onPageChange:t},null,8,["pagination-data"])])]),B(xe,{show:w.value,mode:z.value,tipo:"pedidos",selected:E.value||{},auditoria:Z.value,onClose:b,onConfirmDelete:ie,onConfirmEmail:ce,onEditar:ae,onEnviarVenta:oe,onEnviarCotizacion:le},null,8,["show","mode","selected","auditoria"]),P.value?(p(),g("div",lt,a[3]||(a[3]=[r("div",{class:"bg-white p-6 rounded-lg shadow-lg"},[r("div",{class:"flex items-center space-x-3"},[r("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"}),r("span",{class:"text-gray-700"},"Procesando...")])],-1)]))):C("",!0)])],64))}}),xt=re(dt,[["__scopeId","data-v-fe716b54"]]);export{xt as default};
