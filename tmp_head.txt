<?php

namespace App\Http\Controllers;

use App\Enums\EstadoCompra;
use App\Models\Compra; // <-- Importa el modelo Compra aquí
use App\Models\CuentasPorPagar;
use App\Models\OrdenCompra;
use App\Models\Producto;
use App\Models\ProductoPrecioHistorial;
use App\Models\Proveedor;
use App\Services\InventarioService;
use App\Mail\OrdenCompraEnviada;
use Illuminate\Http\Request;
use Illuminate\Validation\ValidationException;
use Inertia\Inertia;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB; // Para transacciones de base de datos
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Auth;
use Illuminate\Pagination\LengthAwarePaginator;
use Barryvdh\DomPDF\Facade\Pdf;

class OrdenCompraController extends Controller
{
    public function __construct(private readonly InventarioService $inventarioService)
    {
    }

    /**
     * Muestra una lista de las órdenes de compra.
     *
     * @return \Illuminate\Http\Response
     */
    public function index(Request $request)
    {
        $perPage = (int) ($request->integer('per_page') ?: 10);

        $baseQuery = OrdenCompra::with([
            'proveedor' => function ($query) {
                $query->select('id', 'nombre_razon_social', 'email', 'rfc', 'telefono');
            },
            'productos',
            'almacen',
            'emailEnviadoPor' => function ($query) {
                $query->select('id', 'name');
            },
        ]);

        // Aplicar filtros
        if ($search = trim($request->get('search', ''))) {
            $baseQuery->where(function ($query) use ($search) {
                $query->where('numero_orden', 'like', "%{$search}%")
                    ->orWhere('observaciones', 'like', "%{$search}%")
                    ->orWhereHas('proveedor', function ($q) use ($search) {
                        $q->where('nombre_razon_social', 'like', "%{$search}%")
                            ->orWhere('rfc', 'like', "%{$search}%");
                    })
                    ->orWhereHas('productos', function ($q) use ($search) {
                        $q->where('nombre', 'like', "%{$search}%")
                            ->orWhere('descripcion', 'like', "%{$search}%");
                    });
            });
        }

        if ($request->filled('estado')) {
            $baseQuery->where('estado', $request->estado);
        }

        if ($request->filled('prioridad')) {
            $baseQuery->where('prioridad', $request->prioridad);
        }

        if ($request->filled('proveedor_id')) {
            $baseQuery->where('proveedor_id', $request->proveedor_id);
        }

        if ($request->filled('fecha_desde')) {
            $baseQuery->whereDate('fecha_orden', '>=', $request->fecha_desde);
        }

        if ($request->filled('fecha_hasta')) {
            $baseQuery->whereDate('fecha_orden', '<=', $request->fecha_hasta);
        }

        // Ordenamiento
        $sortBy = $request->get('sort_by', 'created_at');
        $sortDirection = $request->get('sort_direction', 'desc');

             = [
                'numero_orden' => ['numero_orden'] ?: null,
                'fecha_orden' => ['fecha_orden'],
                'fecha_entrega_esperada' => ['fecha_entrega_esperada'],
                'prioridad' => ['prioridad'],
                'proveedor_id' => ['proveedor_id'],
                'direccion_entrega' => ['direccion_entrega'],
                'terminos_pago' => ['terminos_pago'],
                'metodo_pago' => ['metodo_pago'],
                'subtotal' => ['subtotal'],
                'descuento_items' => ['descuento_items'],
                'descuento_general' => ['descuento_general'],
                'iva' => ['iva'],
                'total' => ['total'],
                'observaciones' => ['observaciones'],
                'estado' => 'pendiente',
            ];
            if (Schema::hasColumn('orden_compras', 'almacen_id')) {
                ['almacen_id'] = ['almacen_id'];
            }
             = OrdenCompra::create();

namespace App\Http\Controllers;

use App\Enums\EstadoCompra;
use App\Models\Compra; // <-- Importa el modelo Compra aquí
use App\Models\CuentasPorPagar;
use App\Models\OrdenCompra;
use App\Models\Producto;
use App\Models\ProductoPrecioHistorial;
use App\Models\Proveedor;
